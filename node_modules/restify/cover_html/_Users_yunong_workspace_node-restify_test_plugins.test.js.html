
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>/Users/yunong/workspace/node-restify/test/plugins.test.js -- cover.io</title>
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="bootstrap.css" rel="stylesheet">
    <link href="prettify.css" type="text/css" rel="stylesheet" />
    <style type="text/css">
      html, body {
        font-family: georgia, serif;
      }
      
      .content {
      }
      table#files-table {
        table-layout: fixed;
        width: 94%;
      }

      table#files-table td, table#files-table th {
        width: 11%;
        padding-left: 5px;
        padding-right: 5px;
      }
      
      table#files-table td:first-child, table#files-table th:first-child {
        width: 33%;
      }
      
      .partialuncovered { 
        background: #EE9; 
      }
      
      pre.prettyprint {
        padding-top: 0em;
        border: 5px;
        padding-left: 0em;
        padding-bottom: 0em;
        font-family: Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif;

      }
       
      span.covered {
        border-left: 2px solid lime; 
      }
      
      span.uncovered {
        background: #FDD;
        border-left: 2px solid red; 
      }
      
      span.partial {
        border-left: 2px solid #EE9; 
        background: #FFA;
      }
      
      div.header {
        width: 100%;
        padding: 0;
        margin: 0;
        border-bottom: 1px solid #EEE;
        height: 90px;
        background: #F8F8F8;
      }
      
      div.header-content {
        padding: 1em 3em;
      }
      
      a.index {
        text-decoration: none;
        color: inherit;
        font-size: 11px;
      }
      
      a.coverio {
        text-decoration: none;
        color: inherit;
        font-size: 11px;
      }
      
      div.content > a.index {
        padding-left: 1.5em;
        padding-bottom: 2em;
      }
      
      div.header-content h3 {
        font-weight: normal;
      }
      
      span.filename {
        font-weight: bold;
      }
      
      span.percentage {
        font-weight: bold;
      }
      
      div.stats {
        font-size: 13px;
      }
      
      div.stats span.separator {
        margin-left: 10px;
        margin-right: 10px;
      }
      
      div.stats span.stat-descriptor {
        color: gray;
      }
      
      table.code td.text {
        padding-left: 0px;
        padding-right: 0px;
      }

      .linenos p {
        text-align: left;
        margin: 0;
        padding-right: 0.5em;
        color: #999999;
        font-family: verdana, sans-serif;
        font-size: 0.8em;   /* 12/16 */
        line-height: 16px;  /* 16/12 */
      }

      td.text {
        width: 100%;
        height: 16px;
      }
      
      td.text pre > span {
        padding-top: 3px;
        line-height: 16px;
      }
    
    </style>
    <script src="jquery.min.js"></script>
    <script type="text/javascript" src="prettify.js"></script>
    <script >
    
      $(function() {
        $(".linenos p").css("text-align", "right");
        setTimeout(function() {
          prettyPrint();
        });
      });
    </script>

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  </head>

  <body>

      <div class="content">
        <div class="header">
          <div class="header-content">
            <a class="index" href="index.html">Â« index</a>
            <h3>Coverage for <span class="filename">/Users/yunong/workspace/node-restify/test/plugins.test.js</span> : <span class="percentage">98%</span></h3>
            <div class="stats">
              1041  <span class="stat-descriptor">lines</span>     <span class="separator">| </span> 
              1024  <span class="stat-descriptor">run</span>        <span class="separator">| </span> 
              17  <span class="stat-descriptor">missing</span>    <span class="separator">| </span> 
              0  <span class="stat-descriptor">partial</span>      <span class="separator">| </span> 
              148  <span class="stat-descriptor">blocks</span>     <span class="separator">| </span> 
              140  <span class="stat-descriptor">blocks run</span>  <span class="separator">| </span> 
              8  <span class="stat-descriptor">blocks missing</span>
            </div>
          </div>
        </div>
        <table class="code" cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td class='linenos' valign='top'><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p><p>51</p><p>52</p><p>53</p><p>54</p><p>55</p><p>56</p><p>57</p><p>58</p><p>59</p><p>60</p><p>61</p><p>62</p><p>63</p><p>64</p><p>65</p><p>66</p><p>67</p><p>68</p><p>69</p><p>70</p><p>71</p><p>72</p><p>73</p><p>74</p><p>75</p><p>76</p><p>77</p><p>78</p><p>79</p><p>80</p><p>81</p><p>82</p><p>83</p><p>84</p><p>85</p><p>86</p><p>87</p><p>88</p><p>89</p><p>90</p><p>91</p><p>92</p><p>93</p><p>94</p><p>95</p><p>96</p><p>97</p><p>98</p><p>99</p><p>100</p><p>101</p><p>102</p><p>103</p><p>104</p><p>105</p><p>106</p><p>107</p><p>108</p><p>109</p><p>110</p><p>111</p><p>112</p><p>113</p><p>114</p><p>115</p><p>116</p><p>117</p><p>118</p><p>119</p><p>120</p><p>121</p><p>122</p><p>123</p><p>124</p><p>125</p><p>126</p><p>127</p><p>128</p><p>129</p><p>130</p><p>131</p><p>132</p><p>133</p><p>134</p><p>135</p><p>136</p><p>137</p><p>138</p><p>139</p><p>140</p><p>141</p><p>142</p><p>143</p><p>144</p><p>145</p><p>146</p><p>147</p><p>148</p><p>149</p><p>150</p><p>151</p><p>152</p><p>153</p><p>154</p><p>155</p><p>156</p><p>157</p><p>158</p><p>159</p><p>160</p><p>161</p><p>162</p><p>163</p><p>164</p><p>165</p><p>166</p><p>167</p><p>168</p><p>169</p><p>170</p><p>171</p><p>172</p><p>173</p><p>174</p><p>175</p><p>176</p><p>177</p><p>178</p><p>179</p><p>180</p><p>181</p><p>182</p><p>183</p><p>184</p><p>185</p><p>186</p><p>187</p><p>188</p><p>189</p><p>190</p><p>191</p><p>192</p><p>193</p><p>194</p><p>195</p><p>196</p><p>197</p><p>198</p><p>199</p><p>200</p><p>201</p><p>202</p><p>203</p><p>204</p><p>205</p><p>206</p><p>207</p><p>208</p><p>209</p><p>210</p><p>211</p><p>212</p><p>213</p><p>214</p><p>215</p><p>216</p><p>217</p><p>218</p><p>219</p><p>220</p><p>221</p><p>222</p><p>223</p><p>224</p><p>225</p><p>226</p><p>227</p><p>228</p><p>229</p><p>230</p><p>231</p><p>232</p><p>233</p><p>234</p><p>235</p><p>236</p><p>237</p><p>238</p><p>239</p><p>240</p><p>241</p><p>242</p><p>243</p><p>244</p><p>245</p><p>246</p><p>247</p><p>248</p><p>249</p><p>250</p><p>251</p><p>252</p><p>253</p><p>254</p><p>255</p><p>256</p><p>257</p><p>258</p><p>259</p><p>260</p><p>261</p><p>262</p><p>263</p><p>264</p><p>265</p><p>266</p><p>267</p><p>268</p><p>269</p><p>270</p><p>271</p><p>272</p><p>273</p><p>274</p><p>275</p><p>276</p><p>277</p><p>278</p><p>279</p><p>280</p><p>281</p><p>282</p><p>283</p><p>284</p><p>285</p><p>286</p><p>287</p><p>288</p><p>289</p><p>290</p><p>291</p><p>292</p><p>293</p><p>294</p><p>295</p><p>296</p><p>297</p><p>298</p><p>299</p><p>300</p><p>301</p><p>302</p><p>303</p><p>304</p><p>305</p><p>306</p><p>307</p><p>308</p><p>309</p><p>310</p><p>311</p><p>312</p><p>313</p><p>314</p><p>315</p><p>316</p><p>317</p><p>318</p><p>319</p><p>320</p><p>321</p><p>322</p><p>323</p><p>324</p><p>325</p><p>326</p><p>327</p><p>328</p><p>329</p><p>330</p><p>331</p><p>332</p><p>333</p><p>334</p><p>335</p><p>336</p><p>337</p><p>338</p><p>339</p><p>340</p><p>341</p><p>342</p><p>343</p><p>344</p><p>345</p><p>346</p><p>347</p><p>348</p><p>349</p><p>350</p><p>351</p><p>352</p><p>353</p><p>354</p><p>355</p><p>356</p><p>357</p><p>358</p><p>359</p><p>360</p><p>361</p><p>362</p><p>363</p><p>364</p><p>365</p><p>366</p><p>367</p><p>368</p><p>369</p><p>370</p><p>371</p><p>372</p><p>373</p><p>374</p><p>375</p><p>376</p><p>377</p><p>378</p><p>379</p><p>380</p><p>381</p><p>382</p><p>383</p><p>384</p><p>385</p><p>386</p><p>387</p><p>388</p><p>389</p><p>390</p><p>391</p><p>392</p><p>393</p><p>394</p><p>395</p><p>396</p><p>397</p><p>398</p><p>399</p><p>400</p><p>401</p><p>402</p><p>403</p><p>404</p><p>405</p><p>406</p><p>407</p><p>408</p><p>409</p><p>410</p><p>411</p><p>412</p><p>413</p><p>414</p><p>415</p><p>416</p><p>417</p><p>418</p><p>419</p><p>420</p><p>421</p><p>422</p><p>423</p><p>424</p><p>425</p><p>426</p><p>427</p><p>428</p><p>429</p><p>430</p><p>431</p><p>432</p><p>433</p><p>434</p><p>435</p><p>436</p><p>437</p><p>438</p><p>439</p><p>440</p><p>441</p><p>442</p><p>443</p><p>444</p><p>445</p><p>446</p><p>447</p><p>448</p><p>449</p><p>450</p><p>451</p><p>452</p><p>453</p><p>454</p><p>455</p><p>456</p><p>457</p><p>458</p><p>459</p><p>460</p><p>461</p><p>462</p><p>463</p><p>464</p><p>465</p><p>466</p><p>467</p><p>468</p><p>469</p><p>470</p><p>471</p><p>472</p><p>473</p><p>474</p><p>475</p><p>476</p><p>477</p><p>478</p><p>479</p><p>480</p><p>481</p><p>482</p><p>483</p><p>484</p><p>485</p><p>486</p><p>487</p><p>488</p><p>489</p><p>490</p><p>491</p><p>492</p><p>493</p><p>494</p><p>495</p><p>496</p><p>497</p><p>498</p><p>499</p><p>500</p><p>501</p><p>502</p><p>503</p><p>504</p><p>505</p><p>506</p><p>507</p><p>508</p><p>509</p><p>510</p><p>511</p><p>512</p><p>513</p><p>514</p><p>515</p><p>516</p><p>517</p><p>518</p><p>519</p><p>520</p><p>521</p><p>522</p><p>523</p><p>524</p><p>525</p><p>526</p><p>527</p><p>528</p><p>529</p><p>530</p><p>531</p><p>532</p><p>533</p><p>534</p><p>535</p><p>536</p><p>537</p><p>538</p><p>539</p><p>540</p><p>541</p><p>542</p><p>543</p><p>544</p><p>545</p><p>546</p><p>547</p><p>548</p><p>549</p><p>550</p><p>551</p><p>552</p><p>553</p><p>554</p><p>555</p><p>556</p><p>557</p><p>558</p><p>559</p><p>560</p><p>561</p><p>562</p><p>563</p><p>564</p><p>565</p><p>566</p><p>567</p><p>568</p><p>569</p><p>570</p><p>571</p><p>572</p><p>573</p><p>574</p><p>575</p><p>576</p><p>577</p><p>578</p><p>579</p><p>580</p><p>581</p><p>582</p><p>583</p><p>584</p><p>585</p><p>586</p><p>587</p><p>588</p><p>589</p><p>590</p><p>591</p><p>592</p><p>593</p><p>594</p><p>595</p><p>596</p><p>597</p><p>598</p><p>599</p><p>600</p><p>601</p><p>602</p><p>603</p><p>604</p><p>605</p><p>606</p><p>607</p><p>608</p><p>609</p><p>610</p><p>611</p><p>612</p><p>613</p><p>614</p><p>615</p><p>616</p><p>617</p><p>618</p><p>619</p><p>620</p><p>621</p><p>622</p><p>623</p><p>624</p><p>625</p><p>626</p><p>627</p><p>628</p><p>629</p><p>630</p><p>631</p><p>632</p><p>633</p><p>634</p><p>635</p><p>636</p><p>637</p><p>638</p><p>639</p><p>640</p><p>641</p><p>642</p><p>643</p><p>644</p><p>645</p><p>646</p><p>647</p><p>648</p><p>649</p><p>650</p><p>651</p><p>652</p><p>653</p><p>654</p><p>655</p><p>656</p><p>657</p><p>658</p><p>659</p><p>660</p><p>661</p><p>662</p><p>663</p><p>664</p><p>665</p><p>666</p><p>667</p><p>668</p><p>669</p><p>670</p><p>671</p><p>672</p><p>673</p><p>674</p><p>675</p><p>676</p><p>677</p><p>678</p><p>679</p><p>680</p><p>681</p><p>682</p><p>683</p><p>684</p><p>685</p><p>686</p><p>687</p><p>688</p><p>689</p><p>690</p><p>691</p><p>692</p><p>693</p><p>694</p><p>695</p><p>696</p><p>697</p><p>698</p><p>699</p><p>700</p><p>701</p><p>702</p><p>703</p><p>704</p><p>705</p><p>706</p><p>707</p><p>708</p><p>709</p><p>710</p><p>711</p><p>712</p><p>713</p><p>714</p><p>715</p><p>716</p><p>717</p><p>718</p><p>719</p><p>720</p><p>721</p><p>722</p><p>723</p><p>724</p><p>725</p><p>726</p><p>727</p><p>728</p><p>729</p><p>730</p><p>731</p><p>732</p><p>733</p><p>734</p><p>735</p><p>736</p><p>737</p><p>738</p><p>739</p><p>740</p><p>741</p><p>742</p><p>743</p><p>744</p><p>745</p><p>746</p><p>747</p><p>748</p><p>749</p><p>750</p><p>751</p><p>752</p><p>753</p><p>754</p><p>755</p><p>756</p><p>757</p><p>758</p><p>759</p><p>760</p><p>761</p><p>762</p><p>763</p><p>764</p><p>765</p><p>766</p><p>767</p><p>768</p><p>769</p><p>770</p><p>771</p><p>772</p><p>773</p><p>774</p><p>775</p><p>776</p><p>777</p><p>778</p><p>779</p><p>780</p><p>781</p><p>782</p><p>783</p><p>784</p><p>785</p><p>786</p><p>787</p><p>788</p><p>789</p><p>790</p><p>791</p><p>792</p><p>793</p><p>794</p><p>795</p><p>796</p><p>797</p><p>798</p><p>799</p><p>800</p><p>801</p><p>802</p><p>803</p><p>804</p><p>805</p><p>806</p><p>807</p><p>808</p><p>809</p><p>810</p><p>811</p><p>812</p><p>813</p><p>814</p><p>815</p><p>816</p><p>817</p><p>818</p><p>819</p><p>820</p><p>821</p><p>822</p><p>823</p><p>824</p><p>825</p><p>826</p><p>827</p><p>828</p><p>829</p><p>830</p><p>831</p><p>832</p><p>833</p><p>834</p><p>835</p><p>836</p><p>837</p><p>838</p><p>839</p><p>840</p><p>841</p><p>842</p><p>843</p><p>844</p><p>845</p><p>846</p><p>847</p><p>848</p><p>849</p><p>850</p><p>851</p><p>852</p><p>853</p><p>854</p><p>855</p><p>856</p><p>857</p><p>858</p><p>859</p><p>860</p><p>861</p><p>862</p><p>863</p><p>864</p><p>865</p><p>866</p><p>867</p><p>868</p><p>869</p><p>870</p><p>871</p><p>872</p><p>873</p><p>874</p><p>875</p><p>876</p><p>877</p><p>878</p><p>879</p><p>880</p><p>881</p><p>882</p><p>883</p><p>884</p><p>885</p><p>886</p><p>887</p><p>888</p><p>889</p><p>890</p><p>891</p><p>892</p><p>893</p><p>894</p><p>895</p><p>896</p><p>897</p><p>898</p><p>899</p><p>900</p><p>901</p><p>902</p><p>903</p><p>904</p><p>905</p><p>906</p><p>907</p><p>908</p><p>909</p><p>910</p><p>911</p><p>912</p><p>913</p><p>914</p><p>915</p><p>916</p><p>917</p><p>918</p><p>919</p><p>920</p><p>921</p><p>922</p><p>923</p><p>924</p><p>925</p><p>926</p><p>927</p><p>928</p><p>929</p><p>930</p><p>931</p><p>932</p><p>933</p><p>934</p><p>935</p><p>936</p><p>937</p><p>938</p><p>939</p><p>940</p><p>941</p><p>942</p><p>943</p><p>944</p><p>945</p><p>946</p><p>947</p><p>948</p><p>949</p><p>950</p><p>951</p><p>952</p><p>953</p><p>954</p><p>955</p><p>956</p><p>957</p><p>958</p><p>959</p><p>960</p><p>961</p><p>962</p><p>963</p><p>964</p><p>965</p><p>966</p><p>967</p><p>968</p><p>969</p><p>970</p><p>971</p><p>972</p><p>973</p><p>974</p><p>975</p><p>976</p><p>977</p><p>978</p><p>979</p><p>980</p><p>981</p><p>982</p><p>983</p><p>984</p><p>985</p><p>986</p><p>987</p><p>988</p><p>989</p><p>990</p><p>991</p><p>992</p><p>993</p><p>994</p><p>995</p><p>996</p><p>997</p><p>998</p><p>999</p><p>1000</p><p>1001</p><p>1002</p><p>1003</p><p>1004</p><p>1005</p><p>1006</p><p>1007</p><p>1008</p><p>1009</p><p>1010</p><p>1011</p><p>1012</p><p>1013</p><p>1014</p><p>1015</p><p>1016</p><p>1017</p><p>1018</p><p>1019</p><p>1020</p><p>1021</p><p>1022</p><p>1023</p><p>1024</p><p>1025</p><p>1026</p><p>1027</p><p>1028</p><p>1029</p><p>1030</p><p>1031</p><p>1032</p><p>1033</p><p>1034</p><p>1035</p><p>1036</p><p>1037</p><p>1038</p><p>1039</p><p>1040</p><p>1041</p></td><td class='text' valign='top'><pre class='prettyprint lang-js'><span class='covered'>  // Copyright 2012 Mark Cavage, Inc.  All rights reserved.</span>
<span class='covered'>  </span>
<span class='covered'>  var fs = require(&#39;fs&#39;);</span>
<span class='covered'>  var http = require(&#39;http&#39;);</span>
<span class='covered'>  var net = require(&#39;net&#39;);</span>
<span class='covered'>  var path = require(&#39;path&#39;);</span>
<span class='covered'>  var stream = require(&#39;stream&#39;);</span>
<span class='covered'>  var util = require(&#39;util&#39;);</span>
<span class='covered'>  </span>
<span class='covered'>  var bunyan = require(&#39;bunyan&#39;);</span>
<span class='covered'>  </span>
<span class='covered'>  var restify = require(&#39;../lib&#39;);</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  if (require.cache[__dirname + &#39;/lib/helper.js&#39;])</span>
<span class='covered'>      delete require.cache[__dirname + &#39;/lib/helper.js&#39;];</span>
<span class='covered'>  var helper = require(&#39;./lib/helper.js&#39;);</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  ///--- Globals</span>
<span class='covered'>  </span>
<span class='covered'>  var after = helper.after;</span>
<span class='covered'>  var before = helper.before;</span>
<span class='covered'>  var test = helper.test;</span>
<span class='covered'>  </span>
<span class='covered'>  var PORT = process.env.UNIT_TEST_PORT || 0;</span>
<span class='covered'>  var CLIENT;</span>
<span class='covered'>  var SERVER;</span>
<span class='covered'>  </span>
<span class='covered'>  var FILES_TO_DELETE = [];</span>
<span class='covered'>  var DIRS_TO_DELETE = [];</span>
<span class='covered'>  </span>
<span class='covered'>  ///--- Tests</span>
<span class='covered'>  </span>
<span class='covered'>  before(function (callback) {</span>
<span class='covered'>      try {</span>
<span class='covered'>          SERVER = restify.createServer({</span>
<span class='covered'>              dtrace: helper.dtrace,</span>
<span class='covered'>              log: helper.getLog(&#39;server&#39;)</span>
<span class='covered'>          });</span>
<span class='covered'>  </span>
<span class='covered'>          SERVER.use(restify.acceptParser(SERVER.acceptable));</span>
<span class='covered'>          SERVER.use(restify.authorizationParser());</span>
<span class='covered'>          SERVER.use(restify.dateParser());</span>
<span class='covered'>          SERVER.use(restify.queryParser());</span>
<span class='covered'>  </span>
<span class='covered'>          SERVER.get(&#39;/foo/:id&#39;, function respond(req, res, next) {</span>
<span class='covered'>              res.send();</span>
<span class='covered'>              next();</span>
<span class='covered'>          });</span>
<span class='covered'>  </span>
<span class='covered'>          SERVER.listen(PORT, &#39;127.0.0.1&#39;, function () {</span>
<span class='covered'>              PORT = SERVER.address().port;</span>
<span class='covered'>              CLIENT = restify.createJsonClient({</span>
<span class='covered'>                  url: &#39;http://127.0.0.1:&#39; + PORT,</span>
<span class='covered'>                  dtrace: helper.dtrace,</span>
<span class='covered'>                  retry: false,</span>
<span class='covered'>                  agent: false</span>
<span class='covered'>              });</span>
<span class='covered'>  </span>
<span class='covered'>              process.nextTick(callback);</span>
<span class='covered'>          });</span>
<span class='covered'>      } catch (e) {</span>
<span class='uncovered'>          console.error(e.stack);</span>
<span class='uncovered'>          process.exit(1);</span>
<span class='covered'>      }</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  after(function (callback) {</span>
<span class='covered'>      var i;</span>
<span class='covered'>      try {</span>
<span class='covered'>          for (i = 0; i &lt; FILES_TO_DELETE.length; ++i) {</span>
<span class='covered'>              try {</span>
<span class='covered'>                  fs.unlinkSync(FILES_TO_DELETE[i]);</span>
<span class='covered'>              }</span>
<span class='covered'>              catch (err) { /* normal */</span>
<span class='covered'>              }</span>
<span class='covered'>          }</span>
<span class='covered'>          for (i = 0; i &lt; DIRS_TO_DELETE.length; ++i) {</span>
<span class='covered'>              try {</span>
<span class='covered'>                  fs.rmdirSync(DIRS_TO_DELETE[i]);</span>
<span class='covered'>              }</span>
<span class='covered'>              catch (err) { /* normal */</span>
<span class='covered'>              }</span>
<span class='covered'>          }</span>
<span class='covered'>          SERVER.close(callback);</span>
<span class='covered'>      } catch (e) {</span>
<span class='uncovered'>          console.error(e.stack);</span>
<span class='uncovered'>          process.exit(1);</span>
<span class='covered'>      }</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;accept ok&#39;, function (t) {</span>
<span class='covered'>      CLIENT.get(&#39;/foo/bar&#39;, function (err, _, res) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          t.equal(res.statusCode, 200);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;406&#39;, function (t) {</span>
<span class='covered'>      var opts = {</span>
<span class='covered'>          path: &#39;/foo/bar&#39;,</span>
<span class='covered'>          headers: {</span>
<span class='covered'>              accept: &#39;foo/bar&#39;</span>
<span class='covered'>          }</span>
<span class='covered'>      };</span>
<span class='covered'>      CLIENT.get(opts, function (err, _, res) {</span>
<span class='covered'>          t.equal(res.statusCode, 406);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;authorization basic ok&#39;, function (t) {</span>
<span class='covered'>      var authz = &#39;Basic &#39; + new Buffer(&#39;user:secret&#39;).toString(&#39;base64&#39;);</span>
<span class='covered'>      var opts = {</span>
<span class='covered'>          path: &#39;/foo/bar&#39;,</span>
<span class='covered'>          headers: {</span>
<span class='covered'>              authorization: authz</span>
<span class='covered'>          }</span>
<span class='covered'>      };</span>
<span class='covered'>      CLIENT.get(opts, function (err, _, res) {</span>
<span class='covered'>          t.equal(res.statusCode, 200);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;authorization basic invalid&#39;, function (t) {</span>
<span class='covered'>      var opts = {</span>
<span class='covered'>          path: &#39;/foo/bar&#39;,</span>
<span class='covered'>          headers: {</span>
<span class='covered'>              authorization: &#39;Basic &#39;</span>
<span class='covered'>          }</span>
<span class='covered'>      };</span>
<span class='covered'>      CLIENT.get(opts, function (err, _, res) {</span>
<span class='covered'>          t.equal(res.statusCode, 400);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;query ok&#39;, function (t) {</span>
<span class='covered'>      SERVER.get(&#39;/query/:id&#39;, function (req, res, next) {</span>
<span class='covered'>          t.equal(req.params.id, &#39;foo&#39;);</span>
<span class='covered'>          t.equal(req.params.name, &#39;markc&#39;);</span>
<span class='covered'>          t.equal(req.params.name, &#39;markc&#39;);</span>
<span class='covered'>          res.send();</span>
<span class='covered'>          next();</span>
<span class='covered'>      });</span>
<span class='covered'>  </span>
<span class='covered'>      CLIENT.get(&#39;/query/foo?id=bar&amp;name=markc&#39;, function (err, _, res) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          t.equal(res.statusCode, 200);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;GH-124 query ok no query string&#39;, function (t) {</span>
<span class='covered'>      SERVER.get(&#39;/query/:id&#39;, function (req, res, next) {</span>
<span class='covered'>          t.ok(req.getQuery());</span>
<span class='covered'>          t.equal(typeof (req.getQuery()), &#39;object&#39;);</span>
<span class='covered'>          res.send();</span>
<span class='covered'>          next();</span>
<span class='covered'>      });</span>
<span class='covered'>  </span>
<span class='covered'>      CLIENT.get(&#39;/query/foo&#39;, function (err, _, res) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          t.equal(res.statusCode, 200);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;query object&#39;, function (t) {</span>
<span class='covered'>      SERVER.get(&#39;/query/:id&#39;, function (req, res, next) {</span>
<span class='covered'>          t.equal(req.params.id, &#39;foo&#39;);</span>
<span class='covered'>          t.ok(req.params.name);</span>
<span class='covered'>          t.equal(req.params.name.first, &#39;mark&#39;);</span>
<span class='covered'>          t.equal(req.query.name.last, &#39;cavage&#39;);</span>
<span class='covered'>          res.send();</span>
<span class='covered'>          next();</span>
<span class='covered'>      });</span>
<span class='covered'>  </span>
<span class='covered'>      var p = &#39;/query/foo?name[first]=mark&amp;name[last]=cavage&#39;;</span>
<span class='covered'>      CLIENT.get(p, function (err, _, res) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          t.equal(res.statusCode, 200);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;body url-encoded ok&#39;, function (t) {</span>
<span class='covered'>      SERVER.post(&#39;/bodyurl/:id&#39;,</span>
<span class='covered'>          restify.bodyParser(),</span>
<span class='covered'>          function (req, res, next) {</span>
<span class='covered'>              t.equal(req.params.id, &#39;foo&#39;);</span>
<span class='covered'>              t.equal(req.params.name, &#39;markc&#39;);</span>
<span class='covered'>              t.equal(req.params.phone, &#39;(206) 555-1212&#39;);</span>
<span class='covered'>              res.send();</span>
<span class='covered'>              next();</span>
<span class='covered'>          });</span>
<span class='covered'>  </span>
<span class='covered'>      var opts = {</span>
<span class='covered'>          hostname: &#39;127.0.0.1&#39;,</span>
<span class='covered'>          port: PORT,</span>
<span class='covered'>          path: &#39;/bodyurl/foo?name=markc&#39;,</span>
<span class='covered'>          agent: false,</span>
<span class='covered'>          method: &#39;POST&#39;,</span>
<span class='covered'>          headers: {</span>
<span class='covered'>              &#39;Content-Type&#39;: &#39;application/x-www-form-urlencoded&#39;</span>
<span class='covered'>          }</span>
<span class='covered'>      };</span>
<span class='covered'>      var client = http.request(opts, function (res) {</span>
<span class='covered'>          t.equal(res.statusCode, 200);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  </span>
<span class='covered'>      client.write(&#39;phone=(206)%20555-1212&amp;name=somethingelse&#39;);</span>
<span class='covered'>      client.end();</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;body url-encoded ok (no params)&#39;, function (t) {</span>
<span class='covered'>      SERVER.post(&#39;/bodyurl2/:id&#39;,</span>
<span class='covered'>          restify.bodyParser({ mapParams: false }),</span>
<span class='covered'>          function (req, res, next) {</span>
<span class='covered'>              t.equal(req.params.id, &#39;foo&#39;);</span>
<span class='covered'>              t.equal(req.params.name, &#39;markc&#39;);</span>
<span class='covered'>              t.notOk(req.params.phone);</span>
<span class='covered'>              t.equal(req.body.phone, &#39;(206) 555-1212&#39;);</span>
<span class='covered'>              res.send();</span>
<span class='covered'>              next();</span>
<span class='covered'>          });</span>
<span class='covered'>  </span>
<span class='covered'>      var opts = {</span>
<span class='covered'>          hostname: &#39;127.0.0.1&#39;,</span>
<span class='covered'>          port: PORT,</span>
<span class='covered'>          path: &#39;/bodyurl2/foo?name=markc&#39;,</span>
<span class='covered'>          agent: false,</span>
<span class='covered'>          method: &#39;POST&#39;,</span>
<span class='covered'>          headers: {</span>
<span class='covered'>              &#39;Content-Type&#39;: &#39;application/x-www-form-urlencoded&#39;</span>
<span class='covered'>          }</span>
<span class='covered'>      };</span>
<span class='covered'>      var client = http.request(opts, function (res) {</span>
<span class='covered'>          t.equal(res.statusCode, 200);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>      client.write(&#39;phone=(206)%20555-1212&amp;name=somethingelse&#39;);</span>
<span class='covered'>      client.end();</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;body multipart ok&#39;, function (t) {</span>
<span class='covered'>      SERVER.post(&#39;/multipart/:id&#39;,</span>
<span class='covered'>          restify.bodyParser(),</span>
<span class='covered'>          function (req, res, next) {</span>
<span class='covered'>              t.equal(req.params.id, &#39;foo&#39;);</span>
<span class='covered'>              t.equal(req.params.mood, &#39;happy&#39;);</span>
<span class='covered'>              t.equal(req.params.endorphins, &#39;9000&#39;);</span>
<span class='covered'>              res.send();</span>
<span class='covered'>              next();</span>
<span class='covered'>          });</span>
<span class='covered'>  </span>
<span class='covered'>      var opts = {</span>
<span class='covered'>          hostname: &#39;127.0.0.1&#39;,</span>
<span class='covered'>          port: PORT,</span>
<span class='covered'>          path: &#39;/multipart/foo?mood=happy&#39;,</span>
<span class='covered'>          agent: false,</span>
<span class='covered'>          method: &#39;POST&#39;,</span>
<span class='covered'>          headers: {</span>
<span class='covered'>              &#39;Content-Type&#39;: &#39;multipart/form-data; boundary=huff&#39;</span>
<span class='covered'>          }</span>
<span class='covered'>      };</span>
<span class='covered'>  </span>
<span class='covered'>      var client = http.request(opts, function (res) {</span>
<span class='covered'>          t.equal(res.statusCode, 200);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  </span>
<span class='covered'>      /* JSSTYLED */</span>
<span class='covered'>      client.write(&#39;--huff\r\nContent-Disposition: form-data; name=&quot;endorphins&quot;\r\n\r\n9000\r\n--huff--&#39;);</span>
<span class='covered'>      client.end();</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;body multipart ok custom handling&#39;, function (t) {</span>
<span class='covered'>      var detailsString = &#39;High endorphin levels make you happy. &#39; +</span>
<span class='covered'>          &#39;Mostly... I guess. Whatever.&#39;;</span>
<span class='covered'>      SERVER.post(&#39;/multipart/:id&#39;,</span>
<span class='covered'>          restify.bodyParser({</span>
<span class='covered'>              multipartHandler: function (part) {</span>
<span class='covered'>                  var buffer = new Buffer(0);</span>
<span class='covered'>                  part.on(&#39;data&#39;, function (data) {</span>
<span class='covered'>                      buffer = Buffer.concat([ data ]);</span>
<span class='covered'>                  });</span>
<span class='covered'>  </span>
<span class='covered'>                  part.on(&#39;end&#39;, function () {</span>
<span class='covered'>                      t.equal(part.name, &#39;endorphins&#39;);</span>
<span class='covered'>                      t.equal(buffer.toString(&#39;ascii&#39;), &#39;12&#39;);</span>
<span class='covered'>                  });</span>
<span class='covered'>              },</span>
<span class='covered'>              multipartFileHandler: function (part) {</span>
<span class='covered'>                  var buffer = new Buffer(0);</span>
<span class='covered'>                  part.on(&#39;data&#39;, function (data) {</span>
<span class='covered'>                      buffer = Buffer.concat([ data ]);</span>
<span class='covered'>                  });</span>
<span class='covered'>  </span>
<span class='covered'>                  part.on(&#39;end&#39;, function () {</span>
<span class='covered'>                      t.equal(part.name, &#39;details&#39;);</span>
<span class='covered'>                      t.equal(part.filename, &#39;mood_details.txt&#39;);</span>
<span class='covered'>                      t.equal(buffer.toString(&#39;ascii&#39;), detailsString);</span>
<span class='covered'>                  });</span>
<span class='covered'>              },</span>
<span class='covered'>              mapParams: false</span>
<span class='covered'>          }),</span>
<span class='covered'>          function (req, res, next) {</span>
<span class='covered'>              res.send();</span>
<span class='covered'>              next();</span>
<span class='covered'>          });</span>
<span class='covered'>  </span>
<span class='covered'>      var opts = {</span>
<span class='covered'>          hostname: &#39;127.0.0.1&#39;,</span>
<span class='covered'>          port: PORT,</span>
<span class='covered'>          path: &#39;/multipart/foo?mood=sad&#39;,</span>
<span class='covered'>          agent: false,</span>
<span class='covered'>          method: &#39;POST&#39;,</span>
<span class='covered'>          headers: {</span>
<span class='covered'>              &#39;Content-Type&#39;: &#39;multipart/form-data; boundary=huff&#39;</span>
<span class='covered'>          }</span>
<span class='covered'>      };</span>
<span class='covered'>  </span>
<span class='covered'>      var client = http.request(opts, function (res) {</span>
<span class='covered'>          t.equal(res.statusCode, 200);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  </span>
<span class='covered'>      client.write(&#39;--huff\r\n&#39;);</span>
<span class='covered'>      client.write(&#39;Content-Disposition: form-data; name=&quot;endorphins&quot;\r\n\r\n&#39;);</span>
<span class='covered'>      client.write(&#39;12\r\n&#39;);</span>
<span class='covered'>  </span>
<span class='covered'>      client.write(&#39;--huff\r\n&#39;);</span>
<span class='covered'>      /* JSSTYLED */</span>
<span class='covered'>      client.write(&#39;Content-Disposition: form-data; name=&quot;details&quot;; filename=&quot;mood_details.txt&quot;\r\n&#39;);</span>
<span class='covered'>      client.write(&#39;Content-Type: text/plain\r\n\r\n&#39;);</span>
<span class='covered'>      client.write(detailsString + &#39;\r\n&#39;);</span>
<span class='covered'>      client.write(&#39;--huff--&#39;);</span>
<span class='covered'>  </span>
<span class='covered'>      client.end();</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;body json ok&#39;, function (t) {</span>
<span class='covered'>      SERVER.post(&#39;/body/:id&#39;,</span>
<span class='covered'>          restify.bodyParser(),</span>
<span class='covered'>          function (req, res, next) {</span>
<span class='covered'>              t.equal(req.params.id, &#39;foo&#39;);</span>
<span class='covered'>              t.equal(req.params.name, &#39;markc&#39;);</span>
<span class='covered'>              t.equal(req.params.phone, &#39;(206) 555-1212&#39;);</span>
<span class='covered'>              res.send();</span>
<span class='covered'>              next();</span>
<span class='covered'>          });</span>
<span class='covered'>  </span>
<span class='covered'>      var obj = {</span>
<span class='covered'>          phone: &#39;(206) 555-1212&#39;,</span>
<span class='covered'>          name: &#39;somethingelse&#39;</span>
<span class='covered'>      };</span>
<span class='covered'>      CLIENT.post(&#39;/body/foo?name=markc&#39;, obj, function (err, _, res) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          t.equal(res.statusCode, 200);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  </span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;body json ok (no params)&#39;, function (t) {</span>
<span class='covered'>      SERVER.post(&#39;/body/:id&#39;,</span>
<span class='covered'>          restify.bodyParser({ mapParams: false }),</span>
<span class='covered'>          function (req, res, next) {</span>
<span class='covered'>              t.equal(req.params.id, &#39;foo&#39;);</span>
<span class='covered'>              t.equal(req.params.name, &#39;markc&#39;);</span>
<span class='covered'>              t.notOk(req.params.phone);</span>
<span class='covered'>              t.equal(req.body.phone, &#39;(206) 555-1212&#39;);</span>
<span class='covered'>              res.send();</span>
<span class='covered'>              next();</span>
<span class='covered'>          });</span>
<span class='covered'>  </span>
<span class='covered'>      var obj = {</span>
<span class='covered'>          phone: &#39;(206) 555-1212&#39;,</span>
<span class='covered'>          name: &#39;somethingelse&#39;</span>
<span class='covered'>      };</span>
<span class='covered'>      CLIENT.post(&#39;/body/foo?name=markc&#39;, obj, function (err, _, res) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          t.equal(res.statusCode, 200);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;body json ok (null params)&#39;, function (t) {</span>
<span class='covered'>      var STRING_CLIENT = restify.createStringClient({</span>
<span class='covered'>          url: &#39;http://127.0.0.1:&#39; + PORT,</span>
<span class='covered'>          dtrace: helper.dtrace,</span>
<span class='covered'>          retry: false,</span>
<span class='covered'>          agent: false,</span>
<span class='covered'>          contentType: &#39;application/json&#39;,</span>
<span class='covered'>          accept: &#39;application/json&#39;</span>
<span class='covered'>      });</span>
<span class='covered'>  </span>
<span class='covered'>      SERVER.post(&#39;/body/:id&#39;,</span>
<span class='covered'>          restify.bodyParser(),</span>
<span class='covered'>          function (req, res, next) {</span>
<span class='covered'>              t.equal(req.params.id, &#39;foo&#39;);</span>
<span class='covered'>              t.equal(req.params.name, &#39;markc&#39;);</span>
<span class='covered'>              res.send();</span>
<span class='covered'>              next();</span>
<span class='covered'>          });</span>
<span class='covered'>  </span>
<span class='covered'>      STRING_CLIENT.post(&#39;/body/foo?name=markc&#39;, &#39;null&#39;, function (err, _, res) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          t.equal(res.statusCode, 200);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;GH-318 get request with body (default)&#39;, function (t) {</span>
<span class='covered'>      SERVER.get(&#39;/getWithoutBody&#39;,</span>
<span class='covered'>          restify.bodyParser({ mapParams: true }),</span>
<span class='covered'>          function (req, res, next) {</span>
<span class='covered'>              t.notEqual(req.params.foo, &#39;bar&#39;);</span>
<span class='covered'>              res.send();</span>
<span class='covered'>              next();</span>
<span class='covered'>          });</span>
<span class='covered'>  </span>
<span class='covered'>      var request = &#39;GET /getWithoutBody HTTP/1.1\r\n&#39; +</span>
<span class='covered'>          &#39;Content-Type: application/json\r\n&#39; +</span>
<span class='covered'>          &#39;Content-Length: 13\r\n&#39; +</span>
<span class='covered'>          &#39;\r\n&#39; +</span>
<span class='covered'>          &#39;{&quot;foo&quot;:&quot;bar&quot;}&#39;;</span>
<span class='covered'>  </span>
<span class='covered'>      var client = net.connect({host: &#39;127.0.0.1&#39;, port: PORT}, function () {</span>
<span class='covered'>          client.write(request);</span>
<span class='covered'>      });</span>
<span class='covered'>      client.once(&#39;data&#39;, function (data) {</span>
<span class='covered'>          client.end();</span>
<span class='covered'>      });</span>
<span class='covered'>      client.once(&#39;end&#39;, function () {</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;GH-318 get request with body (requestBodyOnGet=true)&#39;, function (t) {</span>
<span class='covered'>      SERVER.get(&#39;/getWithBody&#39;,</span>
<span class='covered'>          restify.bodyParser({</span>
<span class='covered'>              mapParams: true,</span>
<span class='covered'>              requestBodyOnGet: true</span>
<span class='covered'>          }), function (req, res, next) {</span>
<span class='covered'>              t.equal(req.params.foo, &#39;bar&#39;);</span>
<span class='covered'>              res.send();</span>
<span class='covered'>              next();</span>
<span class='covered'>          });</span>
<span class='covered'>  </span>
<span class='covered'>      var request = &#39;GET /getWithBody HTTP/1.1\r\n&#39; +</span>
<span class='covered'>          &#39;Content-Type: application/json\r\n&#39; +</span>
<span class='covered'>          &#39;Content-Length: 13\r\n&#39; +</span>
<span class='covered'>          &#39;\r\n&#39; +</span>
<span class='covered'>          &#39;{&quot;foo&quot;:&quot;bar&quot;}&#39;;</span>
<span class='covered'>      var client = net.connect({host: &#39;127.0.0.1&#39;, port: PORT}, function () {</span>
<span class='covered'>          client.write(request);</span>
<span class='covered'>      });</span>
<span class='covered'>  </span>
<span class='covered'>      client.once(&#39;data&#39;, function (data) {</span>
<span class='covered'>          client.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  </span>
<span class='covered'>      client.once(&#39;end&#39;, function () {</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;GH-111 JSON Parser not right for arrays&#39;, function (t) {</span>
<span class='covered'>      SERVER.post(&#39;/gh111&#39;,</span>
<span class='covered'>          restify.bodyParser(),</span>
<span class='covered'>          function (req, res, next) {</span>
<span class='covered'>              t.ok(Array.isArray(req.params));</span>
<span class='covered'>              t.equal(req.params[0], &#39;foo&#39;);</span>
<span class='covered'>              t.equal(req.params[1], &#39;bar&#39;);</span>
<span class='covered'>              res.send();</span>
<span class='covered'>              next();</span>
<span class='covered'>          });</span>
<span class='covered'>  </span>
<span class='covered'>      var obj = [&#39;foo&#39;, &#39;bar&#39;];</span>
<span class='covered'>      CLIENT.post(&#39;/gh111&#39;, obj, function (err, _, res) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>          t.equal(res.statusCode, 200);</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;GH-279 more JSON Arrays&#39;, function (t) {</span>
<span class='covered'>      function respond(req, res, next) {</span>
<span class='covered'>          t.ok(Array.isArray(req.params));</span>
<span class='covered'>          t.equal(req.params[0].id, &#39;123654&#39;);</span>
<span class='covered'>          t.ok(req.params[0].name, &#39;mimi&#39;);</span>
<span class='covered'>          t.ok(req.params[1].id, &#39;987654&#39;);</span>
<span class='covered'>          t.ok(req.params[1].name, &#39;pijama&#39;);</span>
<span class='covered'>          res.send(200);</span>
<span class='covered'>          next();</span>
<span class='covered'>      }</span>
<span class='covered'>  </span>
<span class='covered'>      SERVER.post(&#39;/gh279&#39;, restify.jsonBodyParser(), respond);</span>
<span class='covered'>  </span>
<span class='covered'>      var obj = [</span>
<span class='covered'>          {</span>
<span class='covered'>              &#39;id&#39;: &#39;123654&#39;,</span>
<span class='covered'>              &#39;name&#39;: &#39;mimi&#39;</span>
<span class='covered'>          },</span>
<span class='covered'>          {</span>
<span class='covered'>              id: &#39;987654&#39;,</span>
<span class='covered'>              name: &#39;pijama&#39;</span>
<span class='covered'>          }</span>
<span class='covered'>      ];</span>
<span class='covered'>      CLIENT.post(&#39;/gh279&#39;, obj, function (err, _, res) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>          t.equal(res.statusCode, 200);</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;date expired&#39;, function (t) {</span>
<span class='covered'>      var opts = {</span>
<span class='covered'>          path: &#39;/foo/bar&#39;,</span>
<span class='covered'>          headers: {</span>
<span class='covered'>              date: &#39;Tue, 15 Nov 1994 08:12:31 GMT&#39;</span>
<span class='covered'>          }</span>
<span class='covered'>      };</span>
<span class='covered'>      CLIENT.get(opts, function (err, _, res) {</span>
<span class='covered'>          t.ok(err);</span>
<span class='covered'>          t.ok(/Date header .+ is too old/.test(err.message));</span>
<span class='covered'>          t.equal(res.statusCode, 400);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;Conditional Request with correct Etag and headers&#39;, function (t) {</span>
<span class='covered'>      SERVER.get(&#39;/etag/:id&#39;,</span>
<span class='covered'>          function (req, res, next) {</span>
<span class='covered'>              res.etag = &#39;testETag&#39;;</span>
<span class='covered'>              next();</span>
<span class='covered'>          },</span>
<span class='covered'>          restify.conditionalRequest(),</span>
<span class='covered'>          function (req, res, next) {</span>
<span class='uncovered'>              res.body = &#39;testing 304&#39;;</span>
<span class='uncovered'>              res.send();</span>
<span class='uncovered'>              next();</span>
<span class='covered'>          });</span>
<span class='covered'>  </span>
<span class='covered'>      var opts = {</span>
<span class='covered'>          path: &#39;/etag/foo&#39;,</span>
<span class='covered'>          headers: {</span>
<span class='covered'>              &#39;If-Match&#39;: &#39;testETag&#39;,</span>
<span class='covered'>              &#39;If-None-Match&#39;: &#39;testETag&#39;</span>
<span class='covered'>          }</span>
<span class='covered'>      };</span>
<span class='covered'>      CLIENT.get(opts, function (err, _, res) {</span>
<span class='covered'>          t.equal(res.statusCode, 304);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;Conditional Request with mismatched Etag and If-Match&#39;, function (t) {</span>
<span class='covered'>      SERVER.get(&#39;/etag/:id&#39;,</span>
<span class='covered'>          function setEtag(req, res, next) {</span>
<span class='covered'>              res.etag = &#39;testEtag&#39;;</span>
<span class='covered'>              next();</span>
<span class='covered'>          },</span>
<span class='covered'>          restify.conditionalRequest(),</span>
<span class='covered'>          function respond(req, res, next) {</span>
<span class='uncovered'>              res.send();</span>
<span class='uncovered'>              next();</span>
<span class='covered'>          });</span>
<span class='covered'>  </span>
<span class='covered'>      var opts = {</span>
<span class='covered'>          path: &#39;/etag/foo&#39;,</span>
<span class='covered'>          headers: {</span>
<span class='covered'>              &#39;If-Match&#39;: &#39;testETag2&#39;</span>
<span class='covered'>          }</span>
<span class='covered'>      };</span>
<span class='covered'>      CLIENT.get(opts, function (err, _, res) {</span>
<span class='covered'>          t.equal(res.statusCode, 412);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;cdntl req If-Modified header &amp; !modified content&#39;, function (t) {</span>
<span class='covered'>      var now = new Date();</span>
<span class='covered'>      var yesterday = new Date(now.setDate(now.getDate() - 1));</span>
<span class='covered'>      SERVER.get(&#39;/etag/:id&#39;,</span>
<span class='covered'>          function (req, res, next) {</span>
<span class='covered'>              res.header(&#39;Last-Modified&#39;, yesterday);</span>
<span class='covered'>              next();</span>
<span class='covered'>          },</span>
<span class='covered'>          restify.conditionalRequest(),</span>
<span class='covered'>          function (req, res, next) {</span>
<span class='uncovered'>              res.send(&#39;testing 304&#39;);</span>
<span class='uncovered'>              next();</span>
<span class='covered'>          });</span>
<span class='covered'>  </span>
<span class='covered'>      var opts = {</span>
<span class='covered'>          path: &#39;/etag/foo&#39;,</span>
<span class='covered'>          headers: {</span>
<span class='covered'>              &#39;If-Modified-Since&#39;: new Date()</span>
<span class='covered'>          }</span>
<span class='covered'>      };</span>
<span class='covered'>      CLIENT.get(opts, function (err, _, res) {</span>
<span class='covered'>          t.equal(res.statusCode, 304);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;cdtl req  If-Unmodified-Since header,modified content&#39;, function (t) {</span>
<span class='covered'>      var now = new Date();</span>
<span class='covered'>      var yesterday = new Date(now.setDate(now.getDate() - 1));</span>
<span class='covered'>      SERVER.get(&#39;/etag/:id&#39;,</span>
<span class='covered'>          function (req, res, next) {</span>
<span class='covered'>              res.header(&#39;Last-Modified&#39;, new Date());</span>
<span class='covered'>              next();</span>
<span class='covered'>          },</span>
<span class='covered'>          restify.conditionalRequest(),</span>
<span class='covered'>          function (req, res, next) {</span>
<span class='uncovered'>              res.send(&#39;testing 412&#39;);</span>
<span class='uncovered'>              next();</span>
<span class='covered'>          });</span>
<span class='covered'>  </span>
<span class='covered'>      var opts = {</span>
<span class='covered'>          path: &#39;/etag/foo&#39;,</span>
<span class='covered'>          headers: {</span>
<span class='covered'>              &#39;If-Unmodified-Since&#39;: yesterday</span>
<span class='covered'>          }</span>
<span class='covered'>      };</span>
<span class='covered'>      CLIENT.get(opts, function (err, _, res) {</span>
<span class='covered'>          t.equal(res.statusCode, 412);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;cdtl req valid headers, ahead time, unmodified OK&#39;, function (t) {</span>
<span class='covered'>      var now = new Date();</span>
<span class='covered'>      var ahead = new Date(now.getTime() + 1000);</span>
<span class='covered'>      SERVER.get(&#39;/etag/:id&#39;,</span>
<span class='covered'>          function (req, res, next) {</span>
<span class='covered'>              res.header(&#39;Last-Modified&#39;, now);</span>
<span class='covered'>              next();</span>
<span class='covered'>          },</span>
<span class='covered'>          restify.conditionalRequest(),</span>
<span class='covered'>          function (req, res, next) {</span>
<span class='uncovered'>              res.send();</span>
<span class='uncovered'>              next();</span>
<span class='covered'>          });</span>
<span class='covered'>  </span>
<span class='covered'>      var opts = {</span>
<span class='covered'>          path: &#39;/etag/foo&#39;,</span>
<span class='covered'>          headers: {</span>
<span class='covered'>              &#39;If-Modified-Since&#39;: ahead</span>
<span class='covered'>          }</span>
<span class='covered'>      };</span>
<span class='covered'>  </span>
<span class='covered'>      CLIENT.get(opts, function (err, _, res) {</span>
<span class='covered'>          t.equal(res.statusCode, 304);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;cdtl req valid headers, ahead Timezone, modified content&#39;, function (t) {</span>
<span class='covered'>      var now = new Date();</span>
<span class='covered'>      var ahead = new Date(now.setHours(now.getHours() + 5));</span>
<span class='covered'>      SERVER.get(&#39;/etag/:id&#39;,</span>
<span class='covered'>          function (req, res, next) {</span>
<span class='covered'>              res.header(&#39;Last-Modified&#39;, now);</span>
<span class='covered'>              next();</span>
<span class='covered'>          },</span>
<span class='covered'>          restify.conditionalRequest(),</span>
<span class='covered'>          function (req, res, next) {</span>
<span class='covered'>              res.send();</span>
<span class='covered'>              next();</span>
<span class='covered'>          });</span>
<span class='covered'>  </span>
<span class='covered'>      var opts = {</span>
<span class='covered'>          path: &#39;/etag/foo&#39;,</span>
<span class='covered'>          headers: {</span>
<span class='covered'>              &#39;If-Unmodified-Since&#39;: ahead</span>
<span class='covered'>          }</span>
<span class='covered'>      };</span>
<span class='covered'>      CLIENT.get(opts, function (err, _, res) {</span>
<span class='covered'>          t.equal(res.statusCode, 200);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;Conditional PUT with matched Etag and headers&#39;, function (t) {</span>
<span class='covered'>      SERVER.put(&#39;/etag/:id&#39;,</span>
<span class='covered'>          function (req, res, next) {</span>
<span class='covered'>              res.etag = &#39;testETag&#39;;</span>
<span class='covered'>              next();</span>
<span class='covered'>          },</span>
<span class='covered'>          restify.conditionalRequest(),</span>
<span class='covered'>          function (req, res, next) {</span>
<span class='uncovered'>              res.send();</span>
<span class='uncovered'>              next();</span>
<span class='covered'>          });</span>
<span class='covered'>  </span>
<span class='covered'>      var opts = {</span>
<span class='covered'>          path: &#39;/etag/foo&#39;,</span>
<span class='covered'>          headers: {</span>
<span class='covered'>              &#39;If-Match&#39;: &#39;testETag&#39;,</span>
<span class='covered'>              &#39;If-None-Match&#39;: &#39;testETag&#39;</span>
<span class='covered'>          }</span>
<span class='covered'>      };</span>
<span class='covered'>      CLIENT.put(opts, {}, function (err, _, res) {</span>
<span class='covered'>          t.equal(res.statusCode, 412);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;gzip response&#39;, function (t) {</span>
<span class='covered'>      SERVER.get(&#39;/gzip/:id&#39;,</span>
<span class='covered'>          restify.gzipResponse(),</span>
<span class='covered'>          function (req, res, next) {</span>
<span class='covered'>              res.send({</span>
<span class='covered'>                  hello: &#39;world&#39;</span>
<span class='covered'>              });</span>
<span class='covered'>              next();</span>
<span class='covered'>          });</span>
<span class='covered'>  </span>
<span class='covered'>      var opts = {</span>
<span class='covered'>          path: &#39;/gzip/foo&#39;,</span>
<span class='covered'>          headers: {</span>
<span class='covered'>              &#39;Accept-Encoding&#39;: &#39;gzip&#39;</span>
<span class='covered'>          }</span>
<span class='covered'>      };</span>
<span class='covered'>      CLIENT.get(opts, function (err, _, res, obj) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          t.deepEqual({hello: &#39;world&#39;}, obj);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;gzip large response&#39;, function (t) {</span>
<span class='covered'>      var testResponseSize = 65536 * 3;</span>
<span class='covered'>      var TestStream = function () {</span>
<span class='covered'>          this.readable = true;</span>
<span class='covered'>          this.sentSize = 0;</span>
<span class='covered'>          this.totalSize = testResponseSize;</span>
<span class='covered'>          this.interval = null;</span>
<span class='covered'>      };</span>
<span class='covered'>      require(&#39;util&#39;).inherits(TestStream, require(&#39;stream&#39;));</span>
<span class='covered'>      TestStream.prototype.resume = function () {</span>
<span class='covered'>          var self = this;</span>
<span class='covered'>          if (!this.interval) {</span>
<span class='covered'>              this.interval = setInterval(function () {</span>
<span class='covered'>                  var chunkSize = Math.min(self.totalSize -</span>
<span class='covered'>                      self.sentSize, 65536);</span>
<span class='covered'>                  if (chunkSize &gt; 0) {</span>
<span class='covered'>                      var chunk = new Array(chunkSize + 1);</span>
<span class='covered'>                      chunk = chunk.join(&#39;a&#39;);</span>
<span class='covered'>                      self.emit(&#39;data&#39;, chunk);</span>
<span class='covered'>                      self.sentSize += chunkSize;</span>
<span class='covered'>                  } else {</span>
<span class='covered'>                      self.emit(&#39;data&#39;, &#39;&quot;}&#39;);</span>
<span class='covered'>                      self.emit(&#39;end&#39;);</span>
<span class='covered'>                      self.pause();</span>
<span class='covered'>                  }</span>
<span class='covered'>              }, 1);</span>
<span class='covered'>          }</span>
<span class='covered'>      };</span>
<span class='covered'>  </span>
<span class='covered'>      TestStream.prototype.pause = function () {</span>
<span class='covered'>          clearInterval(this.interval);</span>
<span class='covered'>          this.interval = null;</span>
<span class='covered'>      };</span>
<span class='covered'>  </span>
<span class='covered'>      var bodyStream = new TestStream();</span>
<span class='covered'>  </span>
<span class='covered'>      SERVER.get(&#39;/gzip/:id&#39;,</span>
<span class='covered'>          restify.gzipResponse(),</span>
<span class='covered'>          function (req, res, next) {</span>
<span class='covered'>              bodyStream.resume();</span>
<span class='covered'>              res.write(&#39;{&quot;foo&quot;:&quot;&#39;);</span>
<span class='covered'>              bodyStream.pipe(res);</span>
<span class='covered'>              next();</span>
<span class='covered'>          });</span>
<span class='covered'>  </span>
<span class='covered'>      var opts = {</span>
<span class='covered'>          path: &#39;/gzip/foo&#39;,</span>
<span class='covered'>          headers: {</span>
<span class='covered'>              &#39;Accept-Encoding&#39;: &#39;gzip&#39;</span>
<span class='covered'>          }</span>
<span class='covered'>      };</span>
<span class='covered'>      CLIENT.get(opts, function (err, _, res, obj) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          var expectedResponse = {</span>
<span class='covered'>              foo: new Array(testResponseSize + 1).join(&#39;a&#39;)</span>
<span class='covered'>          };</span>
<span class='covered'>          t.deepEqual(expectedResponse, obj);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;gzip body json ok&#39;, function (t) {</span>
<span class='covered'>      SERVER.post(&#39;/body/:id&#39;,</span>
<span class='covered'>          restify.bodyParser(),</span>
<span class='covered'>          function (req, res, next) {</span>
<span class='covered'>              t.equal(req.params.id, &#39;foo&#39;);</span>
<span class='covered'>              t.equal(req.params.name, &#39;markc&#39;);</span>
<span class='covered'>              t.equal(req.params.phone, &#39;(206) 555-1212&#39;);</span>
<span class='covered'>              res.send();</span>
<span class='covered'>              next();</span>
<span class='covered'>          });</span>
<span class='covered'>  </span>
<span class='covered'>      var obj = {</span>
<span class='covered'>          phone: &#39;(206) 555-1212&#39;,</span>
<span class='covered'>          name: &#39;somethingelse&#39;</span>
<span class='covered'>      };</span>
<span class='covered'>      CLIENT.gzip = {};</span>
<span class='covered'>      CLIENT.post(&#39;/body/foo?name=markc&#39;, obj, function (err, _, res) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          t.ok(res);</span>
<span class='covered'>          if (res)</span>
<span class='covered'>              t.equal(res.statusCode, 200);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;static serves static files&#39;, function (t) {</span>
<span class='covered'>      serveStaticTest(t, false, &#39;.tmp&#39;);</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;static serves static files in nested folders&#39;, function (t) {</span>
<span class='covered'>      serveStaticTest(t, false, &#39;.tmp/folder&#39;);</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;static serves static files in with a root regex&#39;, function (t) {</span>
<span class='covered'>      serveStaticTest(t, false, &#39;.tmp&#39;, new RegExp(&#39;/.*&#39;));</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;static serves static files with a root, !greedy, regex&#39;, function (t) {</span>
<span class='covered'>      serveStaticTest(t, false, &#39;.tmp&#39;, new RegExp(&#39;/?.*&#39;));</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;static serves default file&#39;, function (t) {</span>
<span class='covered'>      serveStaticTest(t, true, &#39;.tmp&#39;);</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;GH-379 static serves file with parentheses in path&#39;, function (t) {</span>
<span class='covered'>      serveStaticTest(t, false, &#39;.(tmp)&#39;);</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;audit logger timer test&#39;, function (t) {</span>
<span class='covered'>      // Dirty hack to capture the log record using a ring buffer.</span>
<span class='covered'>      var ringbuffer = new bunyan.RingBuffer({ limit: 1 });</span>
<span class='covered'>  </span>
<span class='covered'>      SERVER.once(&#39;after&#39;, restify.auditLogger({</span>
<span class='covered'>          log: bunyan.createLogger({</span>
<span class='covered'>              name: &#39;audit&#39;,</span>
<span class='covered'>              streams:[ {</span>
<span class='covered'>                  level: &#39;info&#39;,</span>
<span class='covered'>                  type: &#39;raw&#39;,</span>
<span class='covered'>                  stream: ringbuffer</span>
<span class='covered'>              }]</span>
<span class='covered'>          })</span>
<span class='covered'>      }));</span>
<span class='covered'>  </span>
<span class='covered'>      SERVER.get(&#39;/audit&#39;, function aTestHandler(req, res, next) {</span>
<span class='covered'>          req.startHandlerTimer(&#39;audit-sub&#39;);</span>
<span class='covered'>  </span>
<span class='covered'>          setTimeout(function () {</span>
<span class='covered'>              req.endHandlerTimer(&#39;audit-sub&#39;);</span>
<span class='covered'>              res.send(&#39;&#39;);</span>
<span class='covered'>              return (next());</span>
<span class='covered'>          }, 1000);</span>
<span class='covered'>      });</span>
<span class='covered'>  </span>
<span class='covered'>      CLIENT.get(&#39;/audit&#39;, function (err, req, res) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          // check timers</span>
<span class='covered'>          t.ok(ringbuffer.records[0], &#39;no log records&#39;);</span>
<span class='covered'>          t.equal(ringbuffer.records.length, 1, &#39;should only have 1 log record&#39;);</span>
<span class='covered'>          t.ok(ringbuffer.records[0].req.timers.aTestHandler &gt; 1000000,</span>
<span class='covered'>               &#39;atestHandler should be &gt; 1000000&#39;);</span>
<span class='covered'>          t.ok(ringbuffer.records[0].req.timers[&#39;aTestHandler-audit-sub&#39;] &gt;</span>
<span class='covered'>               1000000, &#39;aTestHandler-audit-sub should be &gt; 1000000&#39;);</span>
<span class='covered'>          var handlers = Object.keys(ringbuffer.records[0].req.timers);</span>
<span class='covered'>          t.equal(handlers[handlers.length - 2], &#39;aTestHandler-audit-sub&#39;,</span>
<span class='covered'>                  &#39;sub handler timer not in order&#39;);</span>
<span class='covered'>          t.equal(handlers[handlers.length - 1], &#39;aTestHandler&#39;,</span>
<span class='covered'>                  &#39;aTestHandler not last&#39;);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;audit logger anonymous timer test&#39;, function (t) {</span>
<span class='covered'>      // Dirty hack to capture the log record using a ring buffer.</span>
<span class='covered'>      var ringbuffer = new bunyan.RingBuffer({ limit: 1 });</span>
<span class='covered'>  </span>
<span class='covered'>      SERVER.once(&#39;after&#39;, restify.auditLogger({</span>
<span class='covered'>          log: bunyan.createLogger({</span>
<span class='covered'>              name: &#39;audit&#39;,</span>
<span class='covered'>              streams:[ {</span>
<span class='covered'>                  level: &#39;info&#39;,</span>
<span class='covered'>                  type: &#39;raw&#39;,</span>
<span class='covered'>                  stream: ringbuffer</span>
<span class='covered'>              }]</span>
<span class='covered'>          })</span>
<span class='covered'>      }));</span>
<span class='covered'>  </span>
<span class='covered'>      SERVER.get(&#39;/audit&#39;, function (req, res, next) {</span>
<span class='covered'>          setTimeout(function () {</span>
<span class='covered'>              return (next());</span>
<span class='covered'>          }, 1000);</span>
<span class='covered'>      }, function (req, res, next) {</span>
<span class='covered'>          req.startHandlerTimer(&#39;audit-sub&#39;);</span>
<span class='covered'>  </span>
<span class='covered'>          setTimeout(function () {</span>
<span class='covered'>              req.endHandlerTimer(&#39;audit-sub&#39;);</span>
<span class='covered'>              res.send(&#39;&#39;);</span>
<span class='covered'>              return (next());</span>
<span class='covered'>          }, 1000);</span>
<span class='covered'>      });</span>
<span class='covered'>  </span>
<span class='covered'>      CLIENT.get(&#39;/audit&#39;, function (err, req, res) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          // check timers</span>
<span class='covered'>          t.ok(ringbuffer.records[0], &#39;no log records&#39;);</span>
<span class='covered'>          t.equal(ringbuffer.records.length, 1, &#39;should only have 1 log record&#39;);</span>
<span class='covered'>          t.ok(ringbuffer.records[0].req.timers[&#39;handler-0&#39;] &gt; 1000000,</span>
<span class='covered'>               &#39;handler-0 should be &gt; 1000000&#39;);</span>
<span class='covered'>          t.ok(ringbuffer.records[0].req.timers[&#39;handler-1&#39;] &gt; 1000000,</span>
<span class='covered'>               &#39;handler-1 should be &gt; 1000000&#39;);</span>
<span class='covered'>          t.ok(ringbuffer.records[0].req.timers[&#39;handler-1-audit-sub&#39;] &gt;</span>
<span class='covered'>               1000000, &#39;handler-0-audit-sub should be &gt; 1000000&#39;);</span>
<span class='covered'>          var handlers = Object.keys(ringbuffer.records[0].req.timers);</span>
<span class='covered'>          t.equal(handlers[handlers.length - 2], &#39;handler-1-audit-sub&#39;,</span>
<span class='covered'>                  &#39;sub handler timer not in order&#39;);</span>
<span class='covered'>          t.equal(handlers[handlers.length - 1], &#39;handler-1&#39;,</span>
<span class='covered'>                  &#39;handler-1 not last&#39;);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;GH-774 utf8 corruption in body parser&#39;, function (t) {</span>
<span class='covered'>      var slen = 100000;</span>
<span class='covered'>  </span>
<span class='covered'>      SERVER.post(&#39;/utf8&#39;,</span>
<span class='covered'>          restify.bodyParser({ mapParams: false }),</span>
<span class='covered'>          function (req, res, next) {</span>
<span class='covered'>              t.notOk(/\ufffd/.test(req.body.text));</span>
<span class='covered'>              t.equal(req.body.text.length, slen);</span>
<span class='covered'>              res.send({ len: req.body.text.length });</span>
<span class='covered'>              next();</span>
<span class='covered'>          });</span>
<span class='covered'>  </span>
<span class='covered'>      // create a long string of unicode characters</span>
<span class='covered'>      var tx = &#39;&#39;;</span>
<span class='covered'>      for (var i = 0; i &lt; slen; ++i) tx += &#39;\u2661&#39;;</span>
<span class='covered'>  </span>
<span class='covered'>      CLIENT.post(&#39;/utf8&#39;, { text: tx }, function (err, _, res) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          t.equal(res.statusCode, 200);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  ///--- Privates</span>
<span class='covered'>  function serveStaticTest(t, testDefault, tmpDir, regex) {</span>
<span class='covered'>      var staticContent = &#39;{&quot;content&quot;: &quot;abcdefg&quot;}&#39;;</span>
<span class='covered'>      var staticObj = JSON.parse(staticContent);</span>
<span class='covered'>      var testDir = &#39;public&#39;;</span>
<span class='covered'>      var testFileName = &#39;index.json&#39;;</span>
<span class='covered'>      var routeName = &#39;GET wildcard&#39;;</span>
<span class='covered'>      var tmpPath = path.join(process.cwd(), tmpDir);</span>
<span class='covered'>      fs.mkdir(tmpPath, function (err) {</span>
<span class='covered'>          DIRS_TO_DELETE.push(tmpPath);</span>
<span class='covered'>          var folderPath = path.join(tmpPath, testDir);</span>
<span class='covered'>  </span>
<span class='covered'>          fs.mkdir(folderPath, function (err2) {</span>
<span class='covered'>              t.ifError(err2);</span>
<span class='covered'>  </span>
<span class='covered'>              DIRS_TO_DELETE.push(folderPath);</span>
<span class='covered'>              var file = path.join(folderPath, testFileName);</span>
<span class='covered'>  </span>
<span class='covered'>              fs.writeFile(file, staticContent, function (err3) {</span>
<span class='covered'>                  t.ifError(err3);</span>
<span class='covered'>                  FILES_TO_DELETE.push(file);</span>
<span class='covered'>                  var opts = { directory: tmpPath };</span>
<span class='covered'>                  if (testDefault) {</span>
<span class='covered'>                      opts.defaultFile = testFileName;</span>
<span class='covered'>                      routeName += &#39; with default&#39;;</span>
<span class='covered'>                  }</span>
<span class='covered'>                  var re = regex ||</span>
<span class='covered'>                      new RegExp(&#39;/&#39; + testDir + &#39;/?.*&#39;);</span>
<span class='covered'>  </span>
<span class='covered'>                  SERVER.get({</span>
<span class='covered'>                      path: re,</span>
<span class='covered'>                      name: routeName</span>
<span class='covered'>                  }, restify.serveStatic(opts));</span>
<span class='covered'>  </span>
<span class='covered'>                  var p = &#39;/&#39; + testDir + &#39;/&#39; + testFileName;</span>
<span class='covered'>                  CLIENT.get(p, function (err4, req, res, obj) {</span>
<span class='covered'>                      t.ifError(err4);</span>
<span class='covered'>                      t.equal(res.headers[&#39;cache-control&#39;],</span>
<span class='covered'>                          &#39;public, max-age=3600&#39;);</span>
<span class='covered'>                      t.deepEqual(obj, staticObj);</span>
<span class='covered'>                      t.end();</span>
<span class='covered'>                  });</span>
<span class='covered'>              });</span>
<span class='covered'>          });</span>
<span class='covered'>      });</span>
<span class='covered'>  }</span></pre></td>          
            </tr>
          </tbody>
        </table>
        <a class="index" href="index.html">Â« index</a> | <a class="coverio" href="http://cover.io">cover.io</a>
      </div>
  </body>
</html>
