
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>/Users/yunong/workspace/node-restify/test/client.test.js -- cover.io</title>
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="bootstrap.css" rel="stylesheet">
    <link href="prettify.css" type="text/css" rel="stylesheet" />
    <style type="text/css">
      html, body {
        font-family: georgia, serif;
      }
      
      .content {
      }
      table#files-table {
        table-layout: fixed;
        width: 94%;
      }

      table#files-table td, table#files-table th {
        width: 11%;
        padding-left: 5px;
        padding-right: 5px;
      }
      
      table#files-table td:first-child, table#files-table th:first-child {
        width: 33%;
      }
      
      .partialuncovered { 
        background: #EE9; 
      }
      
      pre.prettyprint {
        padding-top: 0em;
        border: 5px;
        padding-left: 0em;
        padding-bottom: 0em;
        font-family: Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, serif;

      }
       
      span.covered {
        border-left: 2px solid lime; 
      }
      
      span.uncovered {
        background: #FDD;
        border-left: 2px solid red; 
      }
      
      span.partial {
        border-left: 2px solid #EE9; 
        background: #FFA;
      }
      
      div.header {
        width: 100%;
        padding: 0;
        margin: 0;
        border-bottom: 1px solid #EEE;
        height: 90px;
        background: #F8F8F8;
      }
      
      div.header-content {
        padding: 1em 3em;
      }
      
      a.index {
        text-decoration: none;
        color: inherit;
        font-size: 11px;
      }
      
      a.coverio {
        text-decoration: none;
        color: inherit;
        font-size: 11px;
      }
      
      div.content > a.index {
        padding-left: 1.5em;
        padding-bottom: 2em;
      }
      
      div.header-content h3 {
        font-weight: normal;
      }
      
      span.filename {
        font-weight: bold;
      }
      
      span.percentage {
        font-weight: bold;
      }
      
      div.stats {
        font-size: 13px;
      }
      
      div.stats span.separator {
        margin-left: 10px;
        margin-right: 10px;
      }
      
      div.stats span.stat-descriptor {
        color: gray;
      }
      
      table.code td.text {
        padding-left: 0px;
        padding-right: 0px;
      }

      .linenos p {
        text-align: left;
        margin: 0;
        padding-right: 0.5em;
        color: #999999;
        font-family: verdana, sans-serif;
        font-size: 0.8em;   /* 12/16 */
        line-height: 16px;  /* 16/12 */
      }

      td.text {
        width: 100%;
        height: 16px;
      }
      
      td.text pre > span {
        padding-top: 3px;
        line-height: 16px;
      }
    
    </style>
    <script src="jquery.min.js"></script>
    <script type="text/javascript" src="prettify.js"></script>
    <script >
    
      $(function() {
        $(".linenos p").css("text-align", "right");
        setTimeout(function() {
          prettyPrint();
        });
      });
    </script>

    <!-- Le fav and touch icons -->
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  </head>

  <body>

      <div class="content">
        <div class="header">
          <div class="header-content">
            <a class="index" href="index.html">Â« index</a>
            <h3>Coverage for <span class="filename">/Users/yunong/workspace/node-restify/test/client.test.js</span> : <span class="percentage">97%</span></h3>
            <div class="stats">
              864  <span class="stat-descriptor">lines</span>     <span class="separator">| </span> 
              840  <span class="stat-descriptor">run</span>        <span class="separator">| </span> 
              24  <span class="stat-descriptor">missing</span>    <span class="separator">| </span> 
              0  <span class="stat-descriptor">partial</span>      <span class="separator">| </span> 
              120  <span class="stat-descriptor">blocks</span>     <span class="separator">| </span> 
              110  <span class="stat-descriptor">blocks run</span>  <span class="separator">| </span> 
              10  <span class="stat-descriptor">blocks missing</span>
            </div>
          </div>
        </div>
        <table class="code" cellspacing="0" cellpadding="0">
          <tbody>
            <tr>
              <td class='linenos' valign='top'><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p><p>51</p><p>52</p><p>53</p><p>54</p><p>55</p><p>56</p><p>57</p><p>58</p><p>59</p><p>60</p><p>61</p><p>62</p><p>63</p><p>64</p><p>65</p><p>66</p><p>67</p><p>68</p><p>69</p><p>70</p><p>71</p><p>72</p><p>73</p><p>74</p><p>75</p><p>76</p><p>77</p><p>78</p><p>79</p><p>80</p><p>81</p><p>82</p><p>83</p><p>84</p><p>85</p><p>86</p><p>87</p><p>88</p><p>89</p><p>90</p><p>91</p><p>92</p><p>93</p><p>94</p><p>95</p><p>96</p><p>97</p><p>98</p><p>99</p><p>100</p><p>101</p><p>102</p><p>103</p><p>104</p><p>105</p><p>106</p><p>107</p><p>108</p><p>109</p><p>110</p><p>111</p><p>112</p><p>113</p><p>114</p><p>115</p><p>116</p><p>117</p><p>118</p><p>119</p><p>120</p><p>121</p><p>122</p><p>123</p><p>124</p><p>125</p><p>126</p><p>127</p><p>128</p><p>129</p><p>130</p><p>131</p><p>132</p><p>133</p><p>134</p><p>135</p><p>136</p><p>137</p><p>138</p><p>139</p><p>140</p><p>141</p><p>142</p><p>143</p><p>144</p><p>145</p><p>146</p><p>147</p><p>148</p><p>149</p><p>150</p><p>151</p><p>152</p><p>153</p><p>154</p><p>155</p><p>156</p><p>157</p><p>158</p><p>159</p><p>160</p><p>161</p><p>162</p><p>163</p><p>164</p><p>165</p><p>166</p><p>167</p><p>168</p><p>169</p><p>170</p><p>171</p><p>172</p><p>173</p><p>174</p><p>175</p><p>176</p><p>177</p><p>178</p><p>179</p><p>180</p><p>181</p><p>182</p><p>183</p><p>184</p><p>185</p><p>186</p><p>187</p><p>188</p><p>189</p><p>190</p><p>191</p><p>192</p><p>193</p><p>194</p><p>195</p><p>196</p><p>197</p><p>198</p><p>199</p><p>200</p><p>201</p><p>202</p><p>203</p><p>204</p><p>205</p><p>206</p><p>207</p><p>208</p><p>209</p><p>210</p><p>211</p><p>212</p><p>213</p><p>214</p><p>215</p><p>216</p><p>217</p><p>218</p><p>219</p><p>220</p><p>221</p><p>222</p><p>223</p><p>224</p><p>225</p><p>226</p><p>227</p><p>228</p><p>229</p><p>230</p><p>231</p><p>232</p><p>233</p><p>234</p><p>235</p><p>236</p><p>237</p><p>238</p><p>239</p><p>240</p><p>241</p><p>242</p><p>243</p><p>244</p><p>245</p><p>246</p><p>247</p><p>248</p><p>249</p><p>250</p><p>251</p><p>252</p><p>253</p><p>254</p><p>255</p><p>256</p><p>257</p><p>258</p><p>259</p><p>260</p><p>261</p><p>262</p><p>263</p><p>264</p><p>265</p><p>266</p><p>267</p><p>268</p><p>269</p><p>270</p><p>271</p><p>272</p><p>273</p><p>274</p><p>275</p><p>276</p><p>277</p><p>278</p><p>279</p><p>280</p><p>281</p><p>282</p><p>283</p><p>284</p><p>285</p><p>286</p><p>287</p><p>288</p><p>289</p><p>290</p><p>291</p><p>292</p><p>293</p><p>294</p><p>295</p><p>296</p><p>297</p><p>298</p><p>299</p><p>300</p><p>301</p><p>302</p><p>303</p><p>304</p><p>305</p><p>306</p><p>307</p><p>308</p><p>309</p><p>310</p><p>311</p><p>312</p><p>313</p><p>314</p><p>315</p><p>316</p><p>317</p><p>318</p><p>319</p><p>320</p><p>321</p><p>322</p><p>323</p><p>324</p><p>325</p><p>326</p><p>327</p><p>328</p><p>329</p><p>330</p><p>331</p><p>332</p><p>333</p><p>334</p><p>335</p><p>336</p><p>337</p><p>338</p><p>339</p><p>340</p><p>341</p><p>342</p><p>343</p><p>344</p><p>345</p><p>346</p><p>347</p><p>348</p><p>349</p><p>350</p><p>351</p><p>352</p><p>353</p><p>354</p><p>355</p><p>356</p><p>357</p><p>358</p><p>359</p><p>360</p><p>361</p><p>362</p><p>363</p><p>364</p><p>365</p><p>366</p><p>367</p><p>368</p><p>369</p><p>370</p><p>371</p><p>372</p><p>373</p><p>374</p><p>375</p><p>376</p><p>377</p><p>378</p><p>379</p><p>380</p><p>381</p><p>382</p><p>383</p><p>384</p><p>385</p><p>386</p><p>387</p><p>388</p><p>389</p><p>390</p><p>391</p><p>392</p><p>393</p><p>394</p><p>395</p><p>396</p><p>397</p><p>398</p><p>399</p><p>400</p><p>401</p><p>402</p><p>403</p><p>404</p><p>405</p><p>406</p><p>407</p><p>408</p><p>409</p><p>410</p><p>411</p><p>412</p><p>413</p><p>414</p><p>415</p><p>416</p><p>417</p><p>418</p><p>419</p><p>420</p><p>421</p><p>422</p><p>423</p><p>424</p><p>425</p><p>426</p><p>427</p><p>428</p><p>429</p><p>430</p><p>431</p><p>432</p><p>433</p><p>434</p><p>435</p><p>436</p><p>437</p><p>438</p><p>439</p><p>440</p><p>441</p><p>442</p><p>443</p><p>444</p><p>445</p><p>446</p><p>447</p><p>448</p><p>449</p><p>450</p><p>451</p><p>452</p><p>453</p><p>454</p><p>455</p><p>456</p><p>457</p><p>458</p><p>459</p><p>460</p><p>461</p><p>462</p><p>463</p><p>464</p><p>465</p><p>466</p><p>467</p><p>468</p><p>469</p><p>470</p><p>471</p><p>472</p><p>473</p><p>474</p><p>475</p><p>476</p><p>477</p><p>478</p><p>479</p><p>480</p><p>481</p><p>482</p><p>483</p><p>484</p><p>485</p><p>486</p><p>487</p><p>488</p><p>489</p><p>490</p><p>491</p><p>492</p><p>493</p><p>494</p><p>495</p><p>496</p><p>497</p><p>498</p><p>499</p><p>500</p><p>501</p><p>502</p><p>503</p><p>504</p><p>505</p><p>506</p><p>507</p><p>508</p><p>509</p><p>510</p><p>511</p><p>512</p><p>513</p><p>514</p><p>515</p><p>516</p><p>517</p><p>518</p><p>519</p><p>520</p><p>521</p><p>522</p><p>523</p><p>524</p><p>525</p><p>526</p><p>527</p><p>528</p><p>529</p><p>530</p><p>531</p><p>532</p><p>533</p><p>534</p><p>535</p><p>536</p><p>537</p><p>538</p><p>539</p><p>540</p><p>541</p><p>542</p><p>543</p><p>544</p><p>545</p><p>546</p><p>547</p><p>548</p><p>549</p><p>550</p><p>551</p><p>552</p><p>553</p><p>554</p><p>555</p><p>556</p><p>557</p><p>558</p><p>559</p><p>560</p><p>561</p><p>562</p><p>563</p><p>564</p><p>565</p><p>566</p><p>567</p><p>568</p><p>569</p><p>570</p><p>571</p><p>572</p><p>573</p><p>574</p><p>575</p><p>576</p><p>577</p><p>578</p><p>579</p><p>580</p><p>581</p><p>582</p><p>583</p><p>584</p><p>585</p><p>586</p><p>587</p><p>588</p><p>589</p><p>590</p><p>591</p><p>592</p><p>593</p><p>594</p><p>595</p><p>596</p><p>597</p><p>598</p><p>599</p><p>600</p><p>601</p><p>602</p><p>603</p><p>604</p><p>605</p><p>606</p><p>607</p><p>608</p><p>609</p><p>610</p><p>611</p><p>612</p><p>613</p><p>614</p><p>615</p><p>616</p><p>617</p><p>618</p><p>619</p><p>620</p><p>621</p><p>622</p><p>623</p><p>624</p><p>625</p><p>626</p><p>627</p><p>628</p><p>629</p><p>630</p><p>631</p><p>632</p><p>633</p><p>634</p><p>635</p><p>636</p><p>637</p><p>638</p><p>639</p><p>640</p><p>641</p><p>642</p><p>643</p><p>644</p><p>645</p><p>646</p><p>647</p><p>648</p><p>649</p><p>650</p><p>651</p><p>652</p><p>653</p><p>654</p><p>655</p><p>656</p><p>657</p><p>658</p><p>659</p><p>660</p><p>661</p><p>662</p><p>663</p><p>664</p><p>665</p><p>666</p><p>667</p><p>668</p><p>669</p><p>670</p><p>671</p><p>672</p><p>673</p><p>674</p><p>675</p><p>676</p><p>677</p><p>678</p><p>679</p><p>680</p><p>681</p><p>682</p><p>683</p><p>684</p><p>685</p><p>686</p><p>687</p><p>688</p><p>689</p><p>690</p><p>691</p><p>692</p><p>693</p><p>694</p><p>695</p><p>696</p><p>697</p><p>698</p><p>699</p><p>700</p><p>701</p><p>702</p><p>703</p><p>704</p><p>705</p><p>706</p><p>707</p><p>708</p><p>709</p><p>710</p><p>711</p><p>712</p><p>713</p><p>714</p><p>715</p><p>716</p><p>717</p><p>718</p><p>719</p><p>720</p><p>721</p><p>722</p><p>723</p><p>724</p><p>725</p><p>726</p><p>727</p><p>728</p><p>729</p><p>730</p><p>731</p><p>732</p><p>733</p><p>734</p><p>735</p><p>736</p><p>737</p><p>738</p><p>739</p><p>740</p><p>741</p><p>742</p><p>743</p><p>744</p><p>745</p><p>746</p><p>747</p><p>748</p><p>749</p><p>750</p><p>751</p><p>752</p><p>753</p><p>754</p><p>755</p><p>756</p><p>757</p><p>758</p><p>759</p><p>760</p><p>761</p><p>762</p><p>763</p><p>764</p><p>765</p><p>766</p><p>767</p><p>768</p><p>769</p><p>770</p><p>771</p><p>772</p><p>773</p><p>774</p><p>775</p><p>776</p><p>777</p><p>778</p><p>779</p><p>780</p><p>781</p><p>782</p><p>783</p><p>784</p><p>785</p><p>786</p><p>787</p><p>788</p><p>789</p><p>790</p><p>791</p><p>792</p><p>793</p><p>794</p><p>795</p><p>796</p><p>797</p><p>798</p><p>799</p><p>800</p><p>801</p><p>802</p><p>803</p><p>804</p><p>805</p><p>806</p><p>807</p><p>808</p><p>809</p><p>810</p><p>811</p><p>812</p><p>813</p><p>814</p><p>815</p><p>816</p><p>817</p><p>818</p><p>819</p><p>820</p><p>821</p><p>822</p><p>823</p><p>824</p><p>825</p><p>826</p><p>827</p><p>828</p><p>829</p><p>830</p><p>831</p><p>832</p><p>833</p><p>834</p><p>835</p><p>836</p><p>837</p><p>838</p><p>839</p><p>840</p><p>841</p><p>842</p><p>843</p><p>844</p><p>845</p><p>846</p><p>847</p><p>848</p><p>849</p><p>850</p><p>851</p><p>852</p><p>853</p><p>854</p><p>855</p><p>856</p><p>857</p><p>858</p><p>859</p><p>860</p><p>861</p><p>862</p><p>863</p><p>864</p></td><td class='text' valign='top'><pre class='prettyprint lang-js'><span class='covered'>  // Copyright 2012 Mark Cavage &lt;mcavage@gmail.com&gt; All rights reserved.</span>
<span class='covered'>  </span>
<span class='covered'>  var http = require(&#39;http&#39;);</span>
<span class='covered'>  </span>
<span class='covered'>  var crypto = require(&#39;crypto&#39;);</span>
<span class='covered'>  </span>
<span class='covered'>  var uuid = require(&#39;node-uuid&#39;);</span>
<span class='covered'>  </span>
<span class='covered'>  var restify = require(&#39;../lib&#39;);</span>
<span class='covered'>  </span>
<span class='covered'>  if (require.cache[__dirname + &#39;/lib/helper.js&#39;])</span>
<span class='uncovered'>      delete require.cache[__dirname + &#39;/lib/helper.js&#39;];</span>
<span class='covered'>  var helper = require(&#39;./lib/helper.js&#39;);</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  ///--- Globals</span>
<span class='covered'>  </span>
<span class='covered'>  var after = helper.after;</span>
<span class='covered'>  var before = helper.before;</span>
<span class='covered'>  var test = helper.test;</span>
<span class='covered'>  </span>
<span class='covered'>  var PORT = process.env.UNIT_TEST_PORT || 0;</span>
<span class='covered'>  var JSON_CLIENT;</span>
<span class='covered'>  var STR_CLIENT;</span>
<span class='covered'>  var RAW_CLIENT;</span>
<span class='covered'>  var TIMEOUT_CLIENT;</span>
<span class='covered'>  var SERVER;</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  ///--- Helpers</span>
<span class='covered'>  </span>
<span class='covered'>  function sendJson(req, res, next) {</span>
<span class='covered'>      res.send({hello: req.params.hello || req.params.name || null});</span>
<span class='covered'>      next();</span>
<span class='covered'>  }</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  function sendText(req, res, next) {</span>
<span class='covered'>      var text = &#39;hello &#39; + (req.params.hello || req.params.name || &#39;&#39;);</span>
<span class='covered'>  </span>
<span class='covered'>      if (req.headers[&#39;range&#39;]) {</span>
<span class='covered'>          /* JSSTYLED */</span>
<span class='covered'>          var matched = req.headers[&#39;range&#39;].match(/bytes=([0-9]+)-([0-9]*)/);</span>
<span class='covered'>          var start = parseInt(matched[1], 10);</span>
<span class='covered'>          var length = ((matched[2]) ?</span>
<span class='covered'>                        parseInt(matched[2], 10) - start :</span>
<span class='uncovered'>                        undefined);</span>
<span class='covered'>          var hash = crypto.createHash(&#39;md5&#39;);</span>
<span class='covered'>          hash.update(text, &#39;utf8&#39;);</span>
<span class='covered'>          res.header(&#39;content-md5&#39;, hash.digest(&#39;base64&#39;));</span>
<span class='covered'>          res.status(206);</span>
<span class='covered'>          text = text.substr(start, length);</span>
<span class='covered'>      }</span>
<span class='covered'>  </span>
<span class='covered'>      res.send(text);</span>
<span class='covered'>      next();</span>
<span class='covered'>  }</span>
<span class='covered'>  </span>
<span class='covered'>  function sendSignature(req, res, next) {</span>
<span class='covered'>      res.header(&#39;content-type&#39;, &#39;text/plain&#39;);</span>
<span class='covered'>      var hdr = req.header(&#39;Awesome-Signature&#39;);</span>
<span class='covered'>      if (!hdr) {</span>
<span class='covered'>          res.send(&#39;request NOT signed&#39;);</span>
<span class='covered'>      } else {</span>
<span class='covered'>          res.send(&#39;ok: &#39; + hdr);</span>
<span class='covered'>      }</span>
<span class='covered'>  }</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  function sendWhitespace(req, res, next) {</span>
<span class='covered'>      var body = &#39; &#39;;</span>
<span class='covered'>      if (req.params.flavor === &#39;spaces&#39;) {</span>
<span class='covered'>          body = &#39;   &#39;;</span>
<span class='covered'>      } else if (req.params.flavor === &#39;tabs&#39;) {</span>
<span class='covered'>          body = &#39; \t\t  &#39;;</span>
<span class='covered'>      }</span>
<span class='covered'>  </span>
<span class='covered'>      // override contentType as otherwise the string is json-ified to</span>
<span class='covered'>      // include quotes. Don&#39;t want that for this test.</span>
<span class='covered'>      res.header(&#39;content-type&#39;, &#39;text/plain&#39;);</span>
<span class='covered'>      res.send(body);</span>
<span class='covered'>      next();</span>
<span class='covered'>  }</span>
<span class='covered'>  </span>
<span class='covered'>  function requestThatTimesOut(req, res, next) {</span>
<span class='covered'>      setTimeout(function () {</span>
<span class='covered'>          res.send(&#39;OK&#39;);</span>
<span class='covered'>          next();</span>
<span class='covered'>      }, 170);</span>
<span class='covered'>  }</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  ///--- Tests</span>
<span class='covered'>  </span>
<span class='covered'>  before(function (callback) {</span>
<span class='covered'>      try {</span>
<span class='covered'>          SERVER = restify.createServer({</span>
<span class='covered'>              dtrace: helper.dtrace,</span>
<span class='covered'>              log: helper.getLog(&#39;server&#39;)</span>
<span class='covered'>          });</span>
<span class='covered'>  </span>
<span class='covered'>          SERVER.use(restify.acceptParser([&#39;json&#39;, &#39;text/plain&#39;]));</span>
<span class='covered'>          SERVER.use(restify.jsonp()); // Added for GH-778</span>
<span class='covered'>          SERVER.use(restify.dateParser());</span>
<span class='covered'>          SERVER.use(restify.authorizationParser());</span>
<span class='covered'>          SERVER.use(restify.queryParser());</span>
<span class='covered'>          SERVER.use(restify.bodyParser());</span>
<span class='covered'>  </span>
<span class='covered'>          SERVER.get(&#39;/signed&#39;, sendSignature);</span>
<span class='covered'>          SERVER.get(&#39;/whitespace/:flavor&#39;, sendWhitespace);</span>
<span class='covered'>  </span>
<span class='covered'>          SERVER.get(&#39;/json/boom&#39;, function (req, res, next) {</span>
<span class='covered'>              res.set(&#39;content-type&#39;, &#39;text/html&#39;);</span>
<span class='covered'>              res.send(200, &#39;&lt;html&gt;&lt;head/&gt;&lt;body/&gt;&lt;/html&gt;&#39;);</span>
<span class='covered'>              next();</span>
<span class='covered'>          });</span>
<span class='covered'>          SERVER.del(&#39;/contentLengthAllowed&#39;, function (req, res, next) {</span>
<span class='covered'>              if (req.header(&#39;content-length&#39;)) {</span>
<span class='covered'>                  res.send(200, &#39;Allowed&#39;);</span>
<span class='covered'>              } else {</span>
<span class='uncovered'>                  res.send(200, &#39;Not allowed&#39;);</span>
<span class='covered'>              }</span>
<span class='covered'>              next();</span>
<span class='covered'>          });</span>
<span class='covered'>  </span>
<span class='covered'>          SERVER.get(&#39;/json/:name&#39;, sendJson);</span>
<span class='covered'>          SERVER.head(&#39;/json/:name&#39;, sendJson);</span>
<span class='covered'>          SERVER.put(&#39;/json/:name&#39;, sendJson);</span>
<span class='covered'>          SERVER.post(&#39;/json/:name&#39;, sendJson);</span>
<span class='covered'>          SERVER.patch(&#39;/json/:name&#39;, sendJson);</span>
<span class='covered'>  </span>
<span class='covered'>          SERVER.get(&#39;/str/request_timeout&#39;, requestThatTimesOut);</span>
<span class='covered'>          SERVER.del(&#39;/str/:name&#39;, sendText);</span>
<span class='covered'>          SERVER.get(&#39;/str/:name&#39;, sendText);</span>
<span class='covered'>          SERVER.head(&#39;/str/:name&#39;, sendText);</span>
<span class='covered'>          SERVER.put(&#39;/str/:name&#39;, sendText);</span>
<span class='covered'>          SERVER.post(&#39;/str/:name&#39;, sendText);</span>
<span class='covered'>          SERVER.patch(&#39;/str/:name&#39;, sendText);</span>
<span class='covered'>  </span>
<span class='covered'>          SERVER.listen(PORT, &#39;127.0.0.1&#39;, function () {</span>
<span class='covered'>              PORT = SERVER.address().port;</span>
<span class='covered'>  </span>
<span class='covered'>              JSON_CLIENT = restify.createJsonClient({</span>
<span class='covered'>                  url: &#39;http://127.0.0.1:&#39; + PORT,</span>
<span class='covered'>                  dtrace: helper.dtrace,</span>
<span class='covered'>                  retry: false</span>
<span class='covered'>              });</span>
<span class='covered'>              STR_CLIENT = restify.createStringClient({</span>
<span class='covered'>                  url: &#39;http://127.0.0.1:&#39; + PORT,</span>
<span class='covered'>                  dtrace: helper.dtrace,</span>
<span class='covered'>                  retry: false</span>
<span class='covered'>              });</span>
<span class='covered'>              RAW_CLIENT = restify.createClient({</span>
<span class='covered'>                  url: &#39;http://127.0.0.1:&#39; + PORT,</span>
<span class='covered'>                  dtrace: helper.dtrace,</span>
<span class='covered'>                  retry: false,</span>
<span class='covered'>                  headers: {</span>
<span class='covered'>                      accept: &#39;text/plain&#39;</span>
<span class='covered'>                  }</span>
<span class='covered'>              });</span>
<span class='covered'>  </span>
<span class='covered'>              TIMEOUT_CLIENT = restify.createStringClient({</span>
<span class='covered'>                  url: &#39;http://127.0.0.1:&#39; + PORT,</span>
<span class='covered'>                  requestTimeout: 150,</span>
<span class='covered'>                  retry: false</span>
<span class='covered'>              });</span>
<span class='covered'>  </span>
<span class='covered'>              process.nextTick(callback);</span>
<span class='covered'>          });</span>
<span class='covered'>      } catch (e) {</span>
<span class='uncovered'>          console.error(e.stack);</span>
<span class='uncovered'>          process.exit(1);</span>
<span class='covered'>      }</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  after(function (callback) {</span>
<span class='covered'>      try {</span>
<span class='covered'>          JSON_CLIENT.close();</span>
<span class='covered'>          STR_CLIENT.close();</span>
<span class='covered'>          RAW_CLIENT.close();</span>
<span class='covered'>          SERVER.close(callback);</span>
<span class='covered'>      } catch (e) {</span>
<span class='uncovered'>          console.error(e.stack);</span>
<span class='uncovered'>          process.exit(1);</span>
<span class='covered'>      }</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;GET json&#39;, function (t) {</span>
<span class='covered'>      JSON_CLIENT.get(&#39;/json/mcavage&#39;, function (err, req, res, obj) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          t.ok(req);</span>
<span class='covered'>          t.ok(res);</span>
<span class='covered'>          t.deepEqual(obj, {hello: &#39;mcavage&#39;});</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;GH-778 GET jsonp&#39;, function (t) {</span>
<span class='covered'>      // Using variables here to keep lines under 80 chars</span>
<span class='covered'>      var jsonpUrl = &#39;/json/jsonp?callback=testCallback&#39;;</span>
<span class='covered'>      var expectedResult = &#39;typeof testCallback === \&#39;function\&#39; &amp;&amp; &#39; +</span>
<span class='covered'>                           &#39;testCallback({&quot;hello&quot;:&quot;jsonp&quot;});&#39;;</span>
<span class='covered'>  </span>
<span class='covered'>      JSON_CLIENT.get(jsonpUrl, function (err, req, res) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          t.ok(req);</span>
<span class='covered'>          t.ok(res);</span>
<span class='covered'>          t.equal(res.body, expectedResult);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;GH-388 GET json, but really HTML&#39;, function (t) {</span>
<span class='covered'>      JSON_CLIENT.get(&#39;/json/boom&#39;, function (err, req, res, obj) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          t.ok(req);</span>
<span class='covered'>          t.ok(res);</span>
<span class='covered'>          t.deepEqual(obj, {});</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;GH-115 GET path with spaces&#39;, function (t) {</span>
<span class='covered'>      // As of node v0.11, this throws, since it&#39;s never valid HTTP</span>
<span class='covered'>      try {</span>
<span class='covered'>          JSON_CLIENT.get(&#39;/json/foo bar&#39;, function (err, req, res, obj) {</span>
<span class='uncovered'>              t.ok(err);</span>
<span class='uncovered'>              t.equal(err.code, &#39;ECONNRESET&#39;);</span>
<span class='uncovered'>              t.end();</span>
<span class='covered'>          });</span>
<span class='covered'>      } catch (err) {</span>
<span class='covered'>          t.ok(err);</span>
<span class='covered'>          t.equal(err.constructor, TypeError);</span>
<span class='covered'>          t.equal(err.message,</span>
<span class='covered'>              &#39;Request path contains unescaped characters.&#39;);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      }</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;Check error (404)&#39;, function (t) {</span>
<span class='uncovered'>      JSON_CLIENT.get(&#39;/&#39; + uuid(), function (err, req, res, obj) {</span>
<span class='uncovered'>          t.ok(err);</span>
<span class='uncovered'>          t.ok(err.message);</span>
<span class='uncovered'>          t.equal(err.statusCode, 404);</span>
<span class='uncovered'>          t.ok(req);</span>
<span class='uncovered'>          t.ok(res);</span>
<span class='uncovered'>          t.ok(obj);</span>
<span class='uncovered'>          t.equal(obj.code, &#39;ResourceNotFound&#39;);</span>
<span class='uncovered'>          t.ok(obj.message);</span>
<span class='uncovered'>          t.end();</span>
<span class='uncovered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;HEAD json&#39;, function (t) {</span>
<span class='covered'>      JSON_CLIENT.head(&#39;/json/mcavage&#39;, function (err, req, res) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          t.ok(req);</span>
<span class='covered'>          t.ok(res);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;POST json&#39;, function (t) {</span>
<span class='covered'>      var data = { hello: &#39;foo&#39; };</span>
<span class='covered'>      JSON_CLIENT.post(&#39;/json/mcavage&#39;, data, function (err, req, res, obj) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          t.ok(req);</span>
<span class='covered'>          t.ok(res);</span>
<span class='covered'>          t.deepEqual(obj, {hello: &#39;foo&#39;});</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;POST json empty body object&#39;, function (t) {</span>
<span class='covered'>      var data = {};</span>
<span class='covered'>      JSON_CLIENT.post(&#39;/json/mcavage&#39;, data, function (err, req, res, obj) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          t.ok(req);</span>
<span class='covered'>          t.ok(res);</span>
<span class='covered'>          t.deepEqual(obj, {hello: &#39;mcavage&#39;});</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;PUT json&#39;, function (t) {</span>
<span class='covered'>      var data = { hello: &#39;foo&#39; };</span>
<span class='covered'>      JSON_CLIENT.put(&#39;/json/mcavage&#39;, data, function (err, req, res, obj) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          t.ok(req);</span>
<span class='covered'>          t.ok(res);</span>
<span class='covered'>          t.deepEqual(obj, {hello: &#39;foo&#39;});</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;PATCH json&#39;, function (t) {</span>
<span class='covered'>      var data = { hello: &#39;foo&#39; };</span>
<span class='covered'>      JSON_CLIENT.patch(&#39;/json/mcavage&#39;, data, function (err, req, res, obj) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          t.ok(req);</span>
<span class='covered'>          t.ok(res);</span>
<span class='covered'>          t.deepEqual(obj, {hello: &#39;foo&#39;});</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;GET text&#39;, function (t) {</span>
<span class='covered'>      STR_CLIENT.get(&#39;/str/mcavage&#39;, function (err, req, res, data) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          t.ok(req);</span>
<span class='covered'>          t.ok(res);</span>
<span class='covered'>          t.equal(res.body, data);</span>
<span class='covered'>          t.equal(data, &#39;hello mcavage&#39;);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;GET PARTIAL text&#39;, function (t) {</span>
<span class='covered'>      var opts = {</span>
<span class='covered'>          path: &#39;/str/mcavage&#39;,</span>
<span class='covered'>          headers: {</span>
<span class='covered'>              Range: &#39;bytes=0-10&#39;</span>
<span class='covered'>          }</span>
<span class='covered'>      };</span>
<span class='covered'>      STR_CLIENT.get(opts, function (err, req, res, data) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          t.ok(req);</span>
<span class='covered'>          t.ok(res);</span>
<span class='covered'>          t.equal(res.body, data);</span>
<span class='covered'>          t.equal(data, &#39;hello mcav&#39;);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;HEAD text&#39;, function (t) {</span>
<span class='covered'>      STR_CLIENT.head(&#39;/str/mcavage&#39;, function (err, req, res) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          t.ok(req);</span>
<span class='covered'>          t.ok(res);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;Check error (404)&#39;, function (t) {</span>
<span class='covered'>      STR_CLIENT.get(&#39;/&#39; + uuid(), function (err, req, res, message) {</span>
<span class='covered'>          t.ok(err);</span>
<span class='covered'>          t.ok(err.message);</span>
<span class='covered'>          t.equal(err.statusCode, 404);</span>
<span class='covered'>          t.ok(req);</span>
<span class='covered'>          t.ok(res);</span>
<span class='covered'>          t.ok(message);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;POST text&#39;, function (t) {</span>
<span class='covered'>      var body = &#39;hello=foo&#39;;</span>
<span class='covered'>      STR_CLIENT.post(&#39;/str/mcavage&#39;, body, function (err, req, res, data) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          t.ok(req);</span>
<span class='covered'>          t.ok(res);</span>
<span class='covered'>          t.equal(res.body, data);</span>
<span class='covered'>          t.equal(data, &#39;hello foo&#39;);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;PATCH text&#39;, function (t) {</span>
<span class='covered'>      var body = &#39;hello=foo&#39;;</span>
<span class='covered'>      STR_CLIENT.patch(&#39;/str/mcavage&#39;, body, function (err, req, res, data) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          t.ok(req);</span>
<span class='covered'>          t.ok(res);</span>
<span class='covered'>          t.equal(res.body, data);</span>
<span class='covered'>          t.equal(data, &#39;hello foo&#39;);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;POST text (object)&#39;, function (t) {</span>
<span class='covered'>      var body = {hello: &#39;foo&#39;};</span>
<span class='covered'>      STR_CLIENT.post(&#39;/str/mcavage&#39;, body, function (err, req, res, data) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          t.ok(req);</span>
<span class='covered'>          t.ok(res);</span>
<span class='covered'>          t.equal(res.body, data);</span>
<span class='covered'>          t.equal(data, &#39;hello foo&#39;);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;POST text empty body string&#39;, function (t) {</span>
<span class='covered'>      var body = &#39;&#39;;</span>
<span class='covered'>      STR_CLIENT.post(&#39;/str/mcavage&#39;, body, function (err, req, res, data) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          t.ok(req);</span>
<span class='covered'>          t.ok(res);</span>
<span class='covered'>          t.equal(res.body, data);</span>
<span class='covered'>          t.equal(data, &#39;hello mcavage&#39;);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;POST text null body&#39;, function (t) {</span>
<span class='covered'>      var body = null;</span>
<span class='covered'>      STR_CLIENT.post(&#39;/str/mcavage&#39;, body, function (err, req, res, data) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          t.ok(req);</span>
<span class='covered'>          t.ok(res);</span>
<span class='covered'>          t.equal(res.body, data);</span>
<span class='covered'>          t.equal(data, &#39;hello mcavage&#39;);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;POST text empty body object&#39;, function (t) {</span>
<span class='covered'>      var body = {};</span>
<span class='covered'>      STR_CLIENT.post(&#39;/str/mcavage&#39;, body, function (err, req, res, data) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          t.ok(req);</span>
<span class='covered'>          t.ok(res);</span>
<span class='covered'>          t.equal(res.body, data);</span>
<span class='covered'>          t.equal(data, &#39;hello mcavage&#39;);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;PUT text&#39;, function (t) {</span>
<span class='covered'>      var body = &#39;hello=foo&#39;;</span>
<span class='covered'>      STR_CLIENT.put(&#39;/str/mcavage&#39;, body, function (err, req, res, data) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          t.ok(req);</span>
<span class='covered'>          t.ok(res);</span>
<span class='covered'>          t.equal(res.body, data);</span>
<span class='covered'>          t.equal(data, &#39;hello foo&#39;);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;PUT text empty body string&#39;, function (t) {</span>
<span class='covered'>      var body = &#39;&#39;;</span>
<span class='covered'>      STR_CLIENT.put(&#39;/str/mcavage&#39;, body, function (err, req, res, data) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          t.ok(req);</span>
<span class='covered'>          t.ok(res);</span>
<span class='covered'>          t.equal(res.body, data);</span>
<span class='covered'>          t.equal(data, &#39;hello mcavage&#39;);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;DELETE text&#39;, function (t) {</span>
<span class='covered'>      STR_CLIENT.del(&#39;/str/mcavage&#39;, function (err, req, res) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          t.ok(req);</span>
<span class='covered'>          t.ok(res);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;DELETE allows content-length&#39;, function (t) {</span>
<span class='covered'>      var opts = {</span>
<span class='covered'>          path: &#39;/contentLengthAllowed&#39;,</span>
<span class='covered'>          headers: {</span>
<span class='covered'>              &#39;content-length&#39;: &#39;0&#39;</span>
<span class='covered'>          }</span>
<span class='covered'>      };</span>
<span class='covered'>  </span>
<span class='covered'>      STR_CLIENT.del(opts, function (err, req, res, obj) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          t.ok(req);</span>
<span class='covered'>          t.ok(res);</span>
<span class='covered'>          t.deepEqual(obj, &#39;Allowed&#39;);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;GET raw&#39;, function (t) {</span>
<span class='covered'>      RAW_CLIENT.get(&#39;/str/mcavage&#39;, function (connectErr, req) {</span>
<span class='covered'>          t.ifError(connectErr);</span>
<span class='covered'>          t.ok(req);</span>
<span class='covered'>  </span>
<span class='covered'>          req.on(&#39;result&#39;, function (err, res) {</span>
<span class='covered'>              t.ifError(err);</span>
<span class='covered'>              res.body = &#39;&#39;;</span>
<span class='covered'>              res.setEncoding(&#39;utf8&#39;);</span>
<span class='covered'>              res.on(&#39;data&#39;, function (chunk) {</span>
<span class='covered'>                  res.body += chunk;</span>
<span class='covered'>              });</span>
<span class='covered'>  </span>
<span class='covered'>              res.on(&#39;end&#39;, function () {</span>
<span class='covered'>                  t.equal(res.body, &#39;hello mcavage&#39;);</span>
<span class='covered'>                  t.end();</span>
<span class='covered'>              });</span>
<span class='covered'>          });</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;POST raw&#39;, function (t) {</span>
<span class='covered'>      var opts = {</span>
<span class='covered'>          path: &#39;/str/mcavage&#39;,</span>
<span class='covered'>          headers: {</span>
<span class='covered'>              &#39;content-type&#39;: &#39;application/x-www-form-urlencoded&#39;</span>
<span class='covered'>          }</span>
<span class='covered'>      };</span>
<span class='covered'>      RAW_CLIENT.post(opts, function (connectErr, req) {</span>
<span class='covered'>          t.ifError(connectErr);</span>
<span class='covered'>  </span>
<span class='covered'>          req.write(&#39;hello=snoopy&#39;);</span>
<span class='covered'>          req.end();</span>
<span class='covered'>  </span>
<span class='covered'>          req.on(&#39;result&#39;, function (err, res) {</span>
<span class='covered'>              t.ifError(err);</span>
<span class='covered'>              res.body = &#39;&#39;;</span>
<span class='covered'>              res.setEncoding(&#39;utf8&#39;);</span>
<span class='covered'>              res.on(&#39;data&#39;, function (chunk) {</span>
<span class='covered'>                  res.body += chunk;</span>
<span class='covered'>              });</span>
<span class='covered'>  </span>
<span class='covered'>              res.on(&#39;end&#39;, function () {</span>
<span class='covered'>                  t.equal(res.body, &#39;hello snoopy&#39;);</span>
<span class='covered'>                  t.end();</span>
<span class='covered'>              });</span>
<span class='covered'>          });</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;PR-726 Enable {agent: false} option override per request&#39;, function (t) {</span>
<span class='covered'>      var opts = {</span>
<span class='covered'>          path: &#39;/str/noagent&#39;,</span>
<span class='covered'>          agent: false</span>
<span class='covered'>      };</span>
<span class='covered'>      RAW_CLIENT.get(opts, function (err, req, res) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          t.notStrictEqual(req.agent, RAW_CLIENT.agent,</span>
<span class='covered'>              &#39;request should not use client agent&#39;);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;GH-20 connectTimeout&#39;, function (t) {</span>
<span class='covered'>      var client = restify.createClient({</span>
<span class='covered'>          url: &#39;http://169.254.1.10&#39;,</span>
<span class='covered'>          type: &#39;http&#39;,</span>
<span class='covered'>          accept: &#39;text/plain&#39;,</span>
<span class='covered'>          connectTimeout: 100,</span>
<span class='covered'>          retry: false,</span>
<span class='covered'>          agent: false</span>
<span class='covered'>      });</span>
<span class='covered'>  </span>
<span class='covered'>      client.get(&#39;/foo&#39;, function (err, req) {</span>
<span class='covered'>          t.ok(err);</span>
<span class='covered'>          t.equal(err.name, &#39;ConnectTimeoutError&#39;);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;requestTimeout&#39;, function (t) {</span>
<span class='covered'>      TIMEOUT_CLIENT.get(&#39;/str/request_timeout&#39;, function (err, req, res, obj) {</span>
<span class='covered'>          t.ok(err);</span>
<span class='covered'>          t.equal(err.name, &#39;RequestTimeoutError&#39;);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;GH-169 PUT json Content-MD5&#39;, function (t) {</span>
<span class='covered'>      var msg = {</span>
<span class='covered'>          &#39;_id&#39;: &#39;4ff71172bc148900000010a3&#39;,</span>
<span class='covered'>          &#39;userId&#39;: &#39;4f711b377579dbf65e000001&#39;,</span>
<span class='covered'>          &#39;courseId&#39;: &#39;4f69021bff338faffa000001&#39;,</span>
<span class='covered'>          &#39;createdByUserId&#39;: &#39;4f711b377579dbf65e000001&#39;,</span>
<span class='covered'>          &#39;dateFrom&#39;: &#39;2012-06-04&#39;,</span>
<span class='covered'>          &#39;dateTo&#39;: &#39;2012-09-30&#39;,</span>
<span class='covered'>          &#39;notes&#39;: &#39;Rates do not include tax &amp; are subject to change &#39; +</span>
<span class='covered'>              &#39;without notice\\nRental Clubs are available for $30 &#39; +</span>
<span class='covered'>              &#39;per set\\nAll major credit cards accepted&#39;,</span>
<span class='covered'>          &#39;updatedAt&#39;: &#39;2012-07-06T17:59:08.581Z&#39;,</span>
<span class='covered'>          &#39;periods&#39;: [</span>
<span class='covered'>              {</span>
<span class='covered'>                  &#39;name&#39;: &#39;morning&#39;,</span>
<span class='covered'>                  &#39;weekdayWalking&#39;: 1500,</span>
<span class='covered'>                  &#39;weekdayCart&#39;: 3000,</span>
<span class='covered'>                  &#39;weekendWalking&#39;: 2000,</span>
<span class='covered'>                  &#39;weekendCart&#39;: 3500,</span>
<span class='covered'>                  &#39;timeFrom&#39;: 0,</span>
<span class='covered'>                  &#39;timeTo&#39;: 780,</span>
<span class='covered'>                  &#39;_id&#39;: &#39;4ff71172bc148900000010a4&#39;</span>
<span class='covered'>              },</span>
<span class='covered'>              {</span>
<span class='covered'>                  &#39;timeFrom&#39;: 780,</span>
<span class='covered'>                  &#39;name&#39;: &#39;twilight&#39;,</span>
<span class='covered'>                  &#39;timeTo&#39;: 900,</span>
<span class='covered'>                  &#39;weekdayWalking&#39;: 1500,</span>
<span class='covered'>                  &#39;weekdayCart&#39;: 2500,</span>
<span class='covered'>                  &#39;weekendWalking&#39;: 1500,</span>
<span class='covered'>                  &#39;weekendCart&#39;: 3000,</span>
<span class='covered'>                  &#39;_id&#39;: &#39;4ff7276cbc148900000010f4&#39;</span>
<span class='covered'>              },</span>
<span class='covered'>              {</span>
<span class='covered'>                  &#39;timeFrom&#39;: 900,</span>
<span class='covered'>                  &#39;name&#39;: &#39;super twilight&#39;,</span>
<span class='covered'>                  &#39;weekdayWalking&#39;: 1200,</span>
<span class='covered'>                  &#39;weekdayCart&#39;: 2000,</span>
<span class='covered'>                  &#39;weekendWalking&#39;: 1200,</span>
<span class='covered'>                  &#39;weekendCart&#39;: 2500,</span>
<span class='covered'>                  &#39;timeTo&#39;: 1439,</span>
<span class='covered'>                  &#39;_id&#39;: &#39;4ff7276cbc148900000010f3&#39;</span>
<span class='covered'>              }</span>
<span class='covered'>          ],</span>
<span class='covered'>          &#39;holidays&#39;: [</span>
<span class='covered'>              {</span>
<span class='covered'>                  &#39;country&#39;: &#39;US&#39;,</span>
<span class='covered'>                  &#39;name&#39;: &#39;Flag Day&#39;,</span>
<span class='covered'>                  &#39;start&#39;: 1339657200000,</span>
<span class='covered'>                  &#39;end&#39;: 1339743600000,</span>
<span class='covered'>                  &#39;date&#39;: &#39;2012-06-14&#39;</span>
<span class='covered'>              },</span>
<span class='covered'>              {</span>
<span class='covered'>                  &#39;country&#39;: &#39;US / MX&#39;,</span>
<span class='covered'>                  &#39;name&#39;: &#39;Father\&#39;s Day, DÃ­a del Padre &#39; +</span>
<span class='covered'>                      &#39;(Father\&#39;s Day)&#39;,</span>
<span class='covered'>                  &#39;start&#39;: 1340262000000,</span>
<span class='covered'>                  &#39;end&#39;: 1340348400000,</span>
<span class='covered'>                  &#39;date&#39;: &#39;2012-06-21&#39;</span>
<span class='covered'>              },</span>
<span class='covered'>              {</span>
<span class='covered'>                  &#39;country&#39;: &#39;US&#39;,</span>
<span class='covered'>                  &#39;name&#39;: &#39;Independence Day&#39;,</span>
<span class='covered'>                  &#39;start&#39;: 1341385200000,</span>
<span class='covered'>                  &#39;end&#39;: 1341471600000,</span>
<span class='covered'>                  &#39;date&#39;: &#39;2012-07-04&#39;</span>
<span class='covered'>              },</span>
<span class='covered'>              {</span>
<span class='covered'>                  &#39;country&#39;: &#39;US&#39;,</span>
<span class='covered'>                  &#39;name&#39;: &#39;Labor Day&#39;,</span>
<span class='covered'>                  &#39;start&#39;: 1347001200000,</span>
<span class='covered'>                  &#39;end&#39;: 1347087600000,</span>
<span class='covered'>                  &#39;date&#39;: &#39;2012-09-07&#39;</span>
<span class='covered'>              }</span>
<span class='covered'>          ],</span>
<span class='covered'>          &#39;weekdaySunday&#39;: false,</span>
<span class='covered'>          &#39;weekdaySaturday&#39;: false,</span>
<span class='covered'>          &#39;weekdayFriday&#39;: false,</span>
<span class='covered'>          &#39;weekdayThursday&#39;: true,</span>
<span class='covered'>          &#39;weekdayWednesday&#39;: true,</span>
<span class='covered'>          &#39;weekdayTuesday&#39;: true,</span>
<span class='covered'>          &#39;weekdayMonday&#39;: true</span>
<span class='covered'>      };</span>
<span class='covered'>  </span>
<span class='covered'>      JSON_CLIENT.put(&#39;/json/md5&#39;, msg, function (err, req, res, obj) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          t.ok(req);</span>
<span class='covered'>          t.ok(res);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;GH-203 GET json, body is whitespace&#39;, function (t) {</span>
<span class='covered'>      JSON_CLIENT.get(&#39;/whitespace/spaces&#39;, function (err, req, res, obj) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          t.ok(req);</span>
<span class='covered'>          t.ok(res);</span>
<span class='covered'>          t.deepEqual(obj, {});</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;GH-203 GET json, body is tabs&#39;, function (t) {</span>
<span class='covered'>      JSON_CLIENT.get(&#39;/whitespace/tabs&#39;, function (err, req, res, obj) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          t.ok(req);</span>
<span class='covered'>          t.ok(res);</span>
<span class='covered'>          t.deepEqual(obj, {});</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;don\&#39;t sign a request&#39;, function (t) {</span>
<span class='covered'>      var client = restify.createClient({</span>
<span class='covered'>          url: &#39;http://127.0.0.1:&#39; + PORT,</span>
<span class='covered'>          type: &#39;string&#39;,</span>
<span class='covered'>          accept: &#39;text/plain&#39;,</span>
<span class='covered'>          headers: { &#39;Gusty-Winds&#39;: &#39;May Exist&#39; },</span>
<span class='covered'>          agent: false</span>
<span class='covered'>      });</span>
<span class='covered'>      client.get(&#39;/signed&#39;, function (err, req, res, data) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          t.ok(data);</span>
<span class='covered'>          t.equal(data, &#39;request NOT signed&#39;);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;sign a request&#39;, function (t) {</span>
<span class='covered'>      var called = 0;</span>
<span class='covered'>      var signer = function sign(request) {</span>
<span class='covered'>          called++;</span>
<span class='covered'>          if (!request || !(request instanceof http.ClientRequest))</span>
<span class='uncovered'>              throw new Error(&#39;request must be an instance of &#39; +</span>
<span class='uncovered'>                  &#39;http.ClientRequest&#39;);</span>
<span class='covered'>          var gw = request.getHeader(&#39;Gusty-Winds&#39;);</span>
<span class='covered'>          if (!gw)</span>
<span class='uncovered'>              throw new Error(&#39;Gusty-Winds header was not &#39; +</span>
<span class='uncovered'>                  &#39;present in request&#39;);</span>
<span class='covered'>          request.setHeader(&#39;Awesome-Signature&#39;, &#39;Gusty Winds &#39; + gw);</span>
<span class='covered'>      };</span>
<span class='covered'>      var client = restify.createClient({</span>
<span class='covered'>          url: &#39;http://127.0.0.1:&#39; + PORT,</span>
<span class='covered'>          type: &#39;string&#39;,</span>
<span class='covered'>          accept: &#39;text/plain&#39;,</span>
<span class='covered'>          signRequest: signer,</span>
<span class='covered'>          headers: { &#39;Gusty-Winds&#39;: &#39;May Exist&#39; },</span>
<span class='covered'>          agent: false</span>
<span class='covered'>      });</span>
<span class='covered'>      client.get(&#39;/signed&#39;, function (err, req, res, data) {</span>
<span class='covered'>          t.ifError(err);</span>
<span class='covered'>          t.ok(data);</span>
<span class='covered'>          t.equal(called, 1);</span>
<span class='covered'>          t.equal(data, &#39;ok: Gusty Winds May Exist&#39;);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  /* BEGIN JSSTYLED */</span>
<span class='covered'>  test(&#39;secure client connection with timeout&#39;, function (t) {</span>
<span class='covered'>      var server = restify.createServer({</span>
<span class='covered'>          certificate: &#39;-----BEGIN CERTIFICATE-----\n&#39; +</span>
<span class='covered'>              &#39;MIICgzCCAewCCQDutc3iIPK88jANBgkqhkiG9w0BAQUFADCBhTELMAkGA1UEBhMC\n&#39; +</span>
<span class='covered'>              &#39;VVMxEzARBgNVBAgMCkNhbGlmb3JuaWExFjAUBgNVBAcMDVNhbiBGcmFuY2lzY28x\n&#39; +</span>
<span class='covered'>              &#39;FTATBgNVBAoMDEpveWVudCwgSW5jLjEPMA0GA1UECwwGUG9ydGFsMSEwHwYJKoZI\n&#39; +</span>
<span class='covered'>              &#39;hvcNAQkBFhJzdXBwb3J0QGpveWVudC5jb20wHhcNMTMxMjAyMjI0NjU3WhcNMTQx\n&#39; +</span>
<span class='covered'>              &#39;MjAyMjI0NjU3WjCBhTELMAkGA1UEBhMCVVMxEzARBgNVBAgMCkNhbGlmb3JuaWEx\n&#39; +</span>
<span class='covered'>              &#39;FjAUBgNVBAcMDVNhbiBGcmFuY2lzY28xFTATBgNVBAoMDEpveWVudCwgSW5jLjEP\n&#39; +</span>
<span class='covered'>              &#39;MA0GA1UECwwGUG9ydGFsMSEwHwYJKoZIhvcNAQkBFhJzdXBwb3J0QGpveWVudC5j\n&#39; +</span>
<span class='covered'>              &#39;b20wgZ8wDQYJKoZIhvcNAQEBBQADgY0AMIGJAoGBANAWr+pYW+AEP4vC48fByPa2\n&#39; +</span>
<span class='covered'>              &#39;Fw0h8FSSgVO2zHyibH9S6nSFaNSLeHRofFdK+cD7IRt4A6jxp57IItNwjFiNNMjF\n&#39; +</span>
<span class='covered'>              &#39;CS5NXKIdPE6HMlb1X7ae+/nN3xRy5321Bi8yQZI6p6b9ATwP8mGBcvx4ta165YFt\n&#39; +</span>
<span class='covered'>              &#39;M2FmaYWLSNbHIwCxTQMJAgMBAAEwDQYJKoZIhvcNAQEFBQADgYEAXFT1q/uB3/fg\n&#39; +</span>
<span class='covered'>              &#39;Iq7iZ6R7q7tBYtd9ttQKp8by8jVToIXP4jUEWZ7vE9TZ1/Wm8ZHxlAPjZtN+rsmS\n&#39; +</span>
<span class='covered'>              &#39;LvgDV22T/s0LgSrdbB/rpYgjsJarlAGfbUYQ6gZKvCMSiZI7oJfl89HDT3PgCtSx\n&#39; +</span>
<span class='covered'>              &#39;RqHcNabt4hoSccUuACJ1FXkszJ312fA=\n&#39; +</span>
<span class='covered'>              &#39;-----END CERTIFICATE-----&#39;,</span>
<span class='covered'>          key: &#39;-----BEGIN RSA PRIVATE KEY-----\n&#39; +</span>
<span class='covered'>              &#39;MIICXAIBAAKBgQDQFq/qWFvgBD+LwuPHwcj2thcNIfBUkoFTtsx8omx/Uup0hWjU\n&#39; +</span>
<span class='covered'>              &#39;i3h0aHxXSvnA+yEbeAOo8aeeyCLTcIxYjTTIxQkuTVyiHTxOhzJW9V+2nvv5zd8U\n&#39; +</span>
<span class='covered'>              &#39;cud9tQYvMkGSOqem/QE8D/JhgXL8eLWteuWBbTNhZmmFi0jWxyMAsU0DCQIDAQAB\n&#39; +</span>
<span class='covered'>              &#39;AoGBAJvz9OHAWRMae/mmFYqXfKMSM1J/Vhw8NLrl7HmYTZJbNSYg+kEZSiyMRmwx\n&#39; +</span>
<span class='covered'>              &#39;3963F8f7eVq7yfFhc2BeIIEZSy23J9QJCqVIqzl6m2URP4+Dw7ZS2iWIsiPyy+L8\n&#39; +</span>
<span class='covered'>              &#39;v8CXPQhRGouOXxU6h7WHpfw+Xy+WPVmIVARMi4UpmmOE52eBAkEA6gui4nD841Ds\n&#39; +</span>
<span class='covered'>              &#39;UEQDMuxNpCf+B20BWKkt8PNODY1HS4rBVCh81oMbaV7VDSabZM7Ba4wrmTAhb1Sc\n&#39; +</span>
<span class='covered'>              &#39;m7bc/YOb0QJBAOObuVTMCbJ7WZhAPHVYhGS5ptuL9fkktj2BPDcf/3KyuDsM6oVw\n&#39; +</span>
<span class='covered'>              &#39;Rs9kUfQrSV+w7YALqxWzNCUgzq+qLYPaGbkCQF5hKuIdph0UuPb1NkUGvZiA+BOO\n&#39; +</span>
<span class='covered'>              &#39;hYh3UKtlsggM/L8dyTBi01S9sgQf1dJjyy4vohf4gmxX2GPIvw6cAynINMECQEjc\n&#39; +</span>
<span class='covered'>              &#39;7TOMLf6JJmFrDu+x6pAkLppR7+hWLFD8Mj6ja69YL0oYFGurSb/Sqbm0scSEa0N2\n&#39; +</span>
<span class='covered'>              &#39;eMp1l9fa7M+ndvKiu2ECQGv4W2+yqlbD3Q3Dr14hiWaiYss5350Ohr5HiZZw2L3i\n&#39; +</span>
<span class='covered'>              &#39;s35vQZaHqRxUVZjOi6/MTCZmqvg/RpaVQYHiJHvxGzw=\n&#39; +</span>
<span class='covered'>              &#39;-----END RSA PRIVATE KEY-----&#39;</span>
<span class='covered'>      });</span>
<span class='covered'>      server.get(&#39;/ping&#39;, function (req, res) {</span>
<span class='covered'>          res.end(&#39;pong&#39;);</span>
<span class='covered'>      });</span>
<span class='covered'>      server.listen(8443);</span>
<span class='covered'>  </span>
<span class='covered'>      var client = restify.createStringClient({url: &#39;https://127.0.0.1:8443&#39;, connectTimeout: 2000, rejectUnauthorized: false});</span>
<span class='covered'>      var timeout = setTimeout(function () {</span>
<span class='uncovered'>          t.ok(false, &#39;timed out&#39;);</span>
<span class='uncovered'>          t.end();</span>
<span class='covered'>      }, 2050);</span>
<span class='covered'>  </span>
<span class='covered'>      client.get(&#39;/ping&#39;, function (err, req, res, body) {</span>
<span class='covered'>          clearTimeout(timeout);</span>
<span class='covered'>          t.equal(body, &#39;pong&#39;);</span>
<span class='covered'>          client.close();</span>
<span class='covered'>          server.close();</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  /* END JSSTYLED */</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;create JSON client with url instead of opts&#39;, function (t) {</span>
<span class='covered'>      var client = restify.createJsonClient(&#39;http://127.0.0.1:&#39; + PORT);</span>
<span class='covered'>      client.agent = false;</span>
<span class='covered'>  </span>
<span class='covered'>      client.get(&#39;/json/mcavage&#39;, function (err, req, res, obj) {</span>
<span class='covered'>          t.deepEqual(obj, {hello: &#39;mcavage&#39;});</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;create string client with url instead of opts&#39;, function (t) {</span>
<span class='covered'>      var client = restify.createStringClient(&#39;http://127.0.0.1:&#39; + PORT);</span>
<span class='covered'>      client.agent = false;</span>
<span class='covered'>  </span>
<span class='covered'>      client.get(&#39;/str/mcavage&#39;, function (err, req, res, data) {</span>
<span class='covered'>          t.equal(data, &#39;hello mcavage&#39;);</span>
<span class='covered'>          t.end();</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;create http client with url instead of opts&#39;, function (t) {</span>
<span class='covered'>      var client = restify.createHttpClient(&#39;http://127.0.0.1:&#39; + PORT);</span>
<span class='covered'>      client.agent = false;</span>
<span class='covered'>  </span>
<span class='covered'>      client.get(&#39;/str/mcavage&#39;, function (err, req) {</span>
<span class='covered'>          req.on(&#39;result&#39;, function (err2, res) {</span>
<span class='covered'>              res.body = &#39;&#39;;</span>
<span class='covered'>              res.setEncoding(&#39;utf8&#39;);</span>
<span class='covered'>              res.on(&#39;data&#39;, function (chunk) {</span>
<span class='covered'>                  res.body += chunk;</span>
<span class='covered'>              });</span>
<span class='covered'>  </span>
<span class='covered'>              res.on(&#39;end&#39;, function () {</span>
<span class='covered'>                  t.equal(res.body, &#39;&quot;hello mcavage&quot;&#39;);</span>
<span class='covered'>                  t.end();</span>
<span class='covered'>              });</span>
<span class='covered'>          });</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span>
<span class='covered'>  </span>
<span class='covered'>  </span>
<span class='covered'>  test(&#39;create base client with url instead of opts&#39;, function (t) {</span>
<span class='covered'>      var client = restify.createClient(&#39;http://127.0.0.1:&#39; + PORT);</span>
<span class='covered'>      client.agent = false;</span>
<span class='covered'>  </span>
<span class='covered'>      client.get(&#39;/str/mcavage&#39;, function (err, req) {</span>
<span class='covered'>          req.on(&#39;result&#39;, function (err2, res) {</span>
<span class='covered'>              res.body = &#39;&#39;;</span>
<span class='covered'>              res.setEncoding(&#39;utf8&#39;);</span>
<span class='covered'>              res.on(&#39;data&#39;, function (chunk) {</span>
<span class='covered'>                  res.body += chunk;</span>
<span class='covered'>              });</span>
<span class='covered'>  </span>
<span class='covered'>              res.on(&#39;end&#39;, function () {</span>
<span class='covered'>                  t.equal(res.body, &#39;&quot;hello mcavage&quot;&#39;);</span>
<span class='covered'>                  t.end();</span>
<span class='covered'>              });</span>
<span class='covered'>          });</span>
<span class='covered'>      });</span>
<span class='covered'>  });</span></pre></td>          
            </tr>
          </tbody>
        </table>
        <a class="index" href="index.html">Â« index</a> | <a class="coverio" href="http://cover.io">cover.io</a>
      </div>
  </body>
</html>
